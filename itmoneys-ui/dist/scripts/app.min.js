"use strict";function LineChars(e,t){this.init(e,t)}function BaseChart(e,t){this.init(e,t)}function TimeSeries(e,t){this.init(e,t)}function SparkLine(e,t){this.init(e,t)}var auth=!1,app=angular.module("raysdata.zeta",["ngAnimate","uiSwitch","ui.checkbox","ui.ace","ngRoute","ngResource","ui.bootstrap","nvd3","ngCookies"]);app.config(["$locationProvider","$routeProvider","$httpProvider",function(e,t,a){a.defaults.headers.put["Content-Type"]="application/json;charset=utf-8",a.defaults.headers.put["Content-Encoding"]="UTF-8",a.defaults.headers.post["Content-Type"]="application/json;charset=utf-8",a.defaults.headers.post["Content-Encoding"]="UTF-8",e.html5Mode(!1),t.when("/",{templateUrl:"views/channel.html",controller:"ChannelController"}).when("/knowledge",{templateUrl:"views/knowledge.html",controller:"KnowledgeController"}).when("/knowledgeinfo",{templateUrl:"views/knowledgeinfo.html",controller:"KnowledgeInfoController"}).when("/datasource",{templateUrl:"views/datasource.html",controller:"DataSourceController"}).when("/dictionary",{templateUrl:"views/dictionary.html",controller:"DictionaryController"}).when("/collector",{templateUrl:"views/collector.html",controller:"CollectorController"}).when("/parser",{templateUrl:"views/parser/list.html",controller:"ParserController"}).when("/analyzer",{templateUrl:"views/analyzer/list.html",controller:"AnalyzerController"}).when("/timer",{templateUrl:"views/timer.html",controller:"TimerController"}).when("/writer",{templateUrl:"views/writer.html",controller:"WriterController"}).when("/metrics",{templateUrl:"views/metrics.html",controller:"MetricsController"}).when("/modeling",{templateUrl:"views/modeling.html",controller:"ModelingController"}).otherwise({redirectTo:"/"});var r={elements:!1,restartOnRequestAfter:20};angular.extend(Pace.options,r),function(e){function t(e,t,a,r,n){return console.log("into interceptor......"),{request:function(e){var t=r.get();return auth&&(t&&""!==t.trim()||window.location.replace("login.html")),e.headers[r.key]=t,e},response:function(e){var t=e.data;return angular.isObject(t),e},responseError:function(t){return e.reject(t)}}}t.$inject=["$q","$rootScope","AUTH_EVENTS","TOKEN"],e.interceptors.push(t)}(a)}]),app.controller("HeaderController",["$scope","CURRENTUSER",function(e,t){console.log(t),e.currentUser=t.get("CURRENTUSER")}]),app.factory("Auth",["$resource",function(e){return e("system/auth/userInfo")}]).service("AuthService",["Auth","Session","Util",function(e,t,a){var r=this;this.hasLogin=function(){return!!t.user},this.hasAuthorized=function(e){return r.hasLogin()&&!(!1===t.auth[e])},this.getAuth=function(r,n){e.get(function(e){if(!a.response.ok(e))return n(e),!1;var s=a.response.getData(e);t.create(s.user.userId,s.user.loginName,s.auth,s.user),r(s.user)},n)}}]).constant("AUTH_EVENTS",{GetAuthSuccess:"auth-success",GetAuthFailed:"auth-failed",SessionTimeout:"auth-session-timeout",LogoutSuccess:"auth-logout-success",LicenseExpired:"auth-license-expired"}),app.service("Session",function(){return this.create=function(e,t,a,r){this.id=e,this.user=t,this.auth=a,this.userobj=r},this.destroy=function(){this.id=null,this.user=null,this.auth=null,this.userobj=null},this}),app.service("TOKEN",["$cookies",function(e){return Object.assign(this,{key:"TOKEN",get:function(t){var a=e.get(this.key);return a&&""!==a.trim()||t&&(a=t),a},clear:function(){e.remove(this.key)}}),this}]),app.service("CURRENTUSERID",["$cookies",function(e){return Object.assign(this,{key:"CURRENTUSERID",get:function(t){var a=e.get(this.key);return a&&""!==a.trim()||t&&(a=t),a},clear:function(){e.remove(this.key)}}),this}]),app.service("CURRENTUSER",["$cookies",function(e){return Object.assign(this,{key:"CURRENTUSER",get:function(t){var a=e.get(this.key);return a&&""!==a.trim()||t&&(a=t),a},clear:function(){e.remove(this.key)}}),this}]),app.directive("reloadWhenClick",["$location","$route",function(e,t){return{restrict:"A",link:function(a,r,n){var s=n.ngHref||r.attr("href");r.click(function(){s.substring(2)==e.path()&&t.reload()})}}}]),app.directive("fileModel",["$parse",function(e){return{restrict:"A",link:function(t,a,r){var n=e(r.fileModel),s=n.assign;a.bind("change",function(){t.$apply(function(){s(t,a[0].files[0])})})}}}]),app.directive("fileModel2",["$parse",function(e){return{restrict:"A",link:function(t,a,r){var n=e(r.fileModel2),s=n.assign;a.bind("change",function(){t.$apply(function(){s(t,a[0].files[0]),console.log(s)})})}}}]),app.directive("fileInput",function(){return{restrict:"A",link:function(e,t,a){$(t).fileinput({showUpload:!1,previewFileType:"text",language:"zh",allowedFileExtensions:["json","txt"],dropZoneEnabled:!0})}}}),app.directive("fileInput2",function(){return{restrict:"A",link:function(e,t,a){$(t).fileinput({showUpload:!1,previewFileType:"text",language:"zh",allowedFileExtensions:["json","txt"],dropZoneEnabled:!0})}}}),app.directive("chart",function(){return{restrict:"E",scope:{width:"@",height:"@",margin:"@",data:"="},controller:["$scope","$element","$attrs","TimeSeriesChart",function(e,t,a,r){r.getChart(t[0],{width:e.width,height:e.height,margin:e.margin}).render(e.data)}]}}),app.directive("sparkLine",function(){return{restrict:"E",scope:{width:"@",height:"@",data:"="},controller:["$scope","$element","$attrs","SparkLineChart",function(e,t,a,r){r.getChart(t[0],{width:e.width,height:e.height}).render(e.data)}]}}),app.directive("page",[function(){return{replace:!0,template:"<div class='hla-widget-foot'>            <ul class='pagination pagination-top'>                <li>                    <span class='bor-none pad-0'>每页显示                         <select ng-model='page.limit' ng-change='load()' ng-blur='first()' ng-options='x for x in [10,20,50]'></select>                    </span>                </li>                <li ng-if='page.current<=1' class='disabled'><span class='op_prev bor-r-5'><i class='glyphicon glyphicon-chevron-left'></i></span></li>                <li ng-if='page.current>1'><span class='op_prev bor-r-5' style='cursor:pointer;' ng-click='prev()'><i class='glyphicon glyphicon-chevron-left'></i></span></li>                <li><span class='op_page_info pad-5 bor-none'>{{page.current}}/{{page.total}}</span></li>                <li ng-if='page.current>=page.total' class='disabled'><span class='op_next bor-r-5'><i class='glyphicon glyphicon-chevron-right'></i></span></li>                <li ng-if='page.current<page.total'><span class='op_next bor-r-5' style='cursor:pointer;' ng-click='next()'><i class='glyphicon glyphicon-chevron-right'></i></span></li>            </ul>            <ul class='pagination pagination-bottom'>                <li>显示第 {{page.start+1}} 到 {{(page.start+page.limit) < page.count? (page.start+page.limit):page.count}} 条数据 , 共 {{page.count}} 项</li>            </ul>        </div>",link:function(e,t,a){if(e.page={start:0,limit:10,current:1,count:0,total:1,search:{},order:"desc",orderBy:"create_time"},!e[a.method])throw new Error("load method is undefined");e.first=function(){e.page.start=0,e.page.current=1,e.load()},e.prev=function(){e.page.current>1&&(e.page.current--,e.page.start-=e.page.limit,e.load())},e.next=function(){e.page.current<e.page.total&&(e.page.start+=e.page.limit,e.page.current++,e.load())},e.check=function(){e.page.current>=e.page.total?(e.page.current=e.page.total,e.page.start=(e.page.current-1)*e.page.limit):e.page.current<=1&&(e.page.current=1,e.page.start=0)},e.last=function(){e.page.current=e.page.total,e.page.start=(e.page.current-1)*e.page.limit,e.load()},e.load=function(t){t&&(e.page.current=t),e[a.method](),e.list.$promise.then(function(t){e.page.count=t.totalCount,e.page.total=Math.ceil(t.totalCount/e.page.limit),e.page.current>1&&e.page.current<e.page.total?e.pages=[e.page.current-1,e.page.current,e.page.current+1]:1==e.page.current&&e.page.total>1?e.pages=[e.page.current,e.page.current+1]:e.page.current==e.page.total&&e.page.total>1&&(e.pages=[e.page.current-1,e.page.current])})},e.load()}}}]),app.directive("ztree",function(){return{require:"?ngModel",restrict:"A",link:function(e,t,a,r){function n(t,r){var n=angular.copy(l),s=e[a.setting];o&&s&&(angular.extend(n.view,s.view),angular.extend(n.data,s.data),angular.extend(n.async,s.async),angular.extend(n.edit,s.edit),angular.extend(n.callback,s.callback));var i=$.fn.zTree.init(t,n,r);t.on("click","span[treenode_switch]",function(e){e.stopPropagation();var t=angular.element(this);if(t.hasClass("root_close")||t.hasClass("root_open")||t.hasClass("center_close")||t.hasClass("center_open")||t.hasClass("bottom_close")||t.hasClass("bottom_open")){var a=i.getNodeByTId(t.parent().attr("id"));i.expandNode(a)}})}var s=a.nodeClick&&null!=a.nodeClick,i=s?a.nodeClick.substring(0,a.nodeClick.lastIndexOf("(")):"",o=a.setting&&null!=a.setting,l={view:{dblClickExpand:!1},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parentId"}},edit:{},async:{enable:!1,contentType:"application/x-www-form-urlencoded",type:"post",dataType:"text",url:"",autoParam:[],otherParam:[],dataFilter:null},callback:{onClick:function(t,a,n,o){e.$apply(function(){r.$setViewValue(n);var l=e.$eval(i);if(s&&l){var c=$.fn.zTree.getZTreeObj(a);!1===l.call(t.target,n,c,o)&&t.stopPropagation()}})},onCollapse:function(e){e.stopPropagation()},onExpand:function(e){e.stopPropagation()}}};a.nodeData&&e.$watch(a.nodeData,function(e,a){e&&e.$promise?e.$promise.then(function(e){n(t,angular.copy(e))}):n(t,angular.copy(e))})}}}),app.directive("treeInput",["$parse",function(){return{restrict:"A",scope:{ngModel:"=",data:"=",callback:"="},replace:!0,link:function(e,t,a){function r(){var t=$.fn.zTree.getZTreeObj("ztree_"+e.$id);t&&t.destroy()}e.set=function(t,a){if(t.isParent)return a.expandNode(t),!1;e.node||(e.node={}),e.node.view=t.name,e.ngModel&&angular.extend(e.ngModel,{name:t.name,id:t.id}),e.callback&&e.callback(t.id,t.name)},a.ngModel&&(e.node&&e.node.view&&delete e.node.view,e.$watch("ngModel",function(t,a){if(t){var r=$.fn.zTree.getZTreeObj("ztree_"+e.$id);e.set(t,r,0,e);var n=r.getNodeByParam("id",t.id);n&&(r.expandNode(r.getNodeByParam("id",n.parentId)),r.selectNode(n))}})),e.clear=function(){delete e.node.view},e.$on("$destroy",r)},template:"<div class='input-group'>                       <input type='text' placeholder='资产类型' name='treeName' readonly='readonly' class='form-control op_log_type'                           data-toggle='dropdown'  ng-model='node.view' required>                        <span title='清除' class='input-group-addon op_clear_log_type mouse-on'  ng-click='clear()'>                            <i class='fa fa-eraser fa-fw'></i>                        </span>                        <div class='dropdown-menu'>                            <ul id='ztree_{{$id}}' class='ztree search' ztree ng-model='node'                                 node-click='set()'                                node-data='data'>                        </ul>                        </div>                    </div>"}}]),app.directive("datetimePicker",function(){return{require:"?ngModel",restrict:"AE",scope:{datetimePicker:"="},link:function(e,t,a,r){function n(e){return e.data("DateTimePicker")}var s={format:"YYYY-MM-DD HH:mm:ss"},i=angular.merge({},s,e.datetimePicker||{}),o=t.parent();if(o.hasClass("input-group")){var l=null;l=0===o.find(".datepickerbutton").length?o.find(".input-group-btn"):o.find(".datepickerbutton"),l.click(function(){t.datetimepicker("show")})}t.datetimepicker(i).on("dp.change",function(){r.$setViewValue(this.value)}),e.$watch("datetimePicker",function(a,r){if(a!==r){var s=n(t);s.options(e.datetimePicker),e.datetimePicker.defaultDate&&(s.date(e.datetimePicker.defaultDate),s.viewDate(e.datetimePicker.defaultDate))}},!0),r.$render=function(){var e=r.$viewValue?moment(r.$viewValue):null;n(t).date(e)},t.on("dp.show",function(e){var t=n(angular.element(e.target)),a=t.options().viewMode;"years"!=a&&"months"!=a||t.viewMode(a)})}}}),app.filter("ParserTypeName",function(){return function(e){switch(e){case"nothing":return"不解析";case"cef":return"CEF";case"delimit":return"分隔符";case"delimitWithKeyMap":return"键值对";case"xml":return"XML";case"json":return"JSON";case"regex":return"正则";case"transfer":return"传输";default:return e.toUpperCase()}}}).filter("AnalyzerTypeName",function(){return function(e){switch(e){case"sql":return"SQL";case"model":return"生产模型";case"analyzer":return"数据分析";default:return e.toUpperCase()}}}).filter("channelTypeName",function(){return function(e){switch(e){case"parser":return"数据解析";case"analyzer":return"数据分析";default:return e.toUpperCase()}}}).filter("SourceTypeName",function(){return function(e){switch(e){case"es2":return"ELASTICSEARCH-2.X";case"es5":return"ELASTICSEARCH-5.X";case"es":return"ELASTICSEARCH";case"net":return"网络";case"single-table":return"通道转数据表";case"tuple":return"通道组合";case"jdbc":return"数据库";case"forward":return"数据转发";case"file":return"本地文件";case"switch":return"条件输出";default:return e.toUpperCase()}}}).filter("writerTypeName",function(){return function(e){switch(e){case"es2":return"ELASTICSEARCH-2.X";case"es5":return"ELASTICSEARCH-5.X";case"es":return"ELASTICSEARCH";case"net":return"网络";case"jdbc":return"数据库";case"forward":return"数据转发";case"file":return"本地文件";case"switch":return"条件输出";default:return e.toUpperCase()}}}).filter("StatusName",function(){return function(e){switch(e){case"RUNNING":return"运行";case"STOPPING":return"正在停止";case"STOPPED":return"停止";case"READING_ERROR":return"读取数据异常";case"WRITER_ERROR":return"写数据异常";case"MONITOR_ERROR":return"停止【创建输入流异常】";case"LEXER_ERROR":return"数据分析异常";case"WORKER_STOPPED":case"UNAVAILABLE":return"采集器已关闭,或者不存在";case"PENDING":return"初始状态";case"STARTING":return"正在启动";case"FINISHED":return"完成";case"NOT_EXEC":return"未执行";case"FAIL":return"失败";default:return"未知"}}}),LineChars.prototype.init=function(e,t){this.target=e,t=t||{},this.canvas=document.createElement("canvas"),this.canvas.width=960,this.canvas.height=500,this.context=this.canvas.getContext("2d"),this.margin=t.margin||{top:20,right:20,bottom:30,left:50},this.width=this.canvas.width-this.margin.left-this.margin.right,this.height=this.canvas.height-this.margin.top-this.margin.bottom,this.x=d3.scaleTime().range([0,this.width]),this.y=d3.scaleLinear().range([this.height,0]);var a=this.x,r=this.y;this.line=d3.line().x(function(e){return a(e.time)}).y(function(e){return r(e.cpu)}).curve(d3.curveStep).context(this.context)},LineChars.prototype.xAxis=function(){var e=this.height,t=this.x,a=this.context,r=t.ticks(10),n=t.tickFormat();a.beginPath(),r.forEach(function(r){a.moveTo(t(r),e),a.lineTo(t(r),e+6)}),a.strokeStyle="black",a.stroke(),a.textAlign="center",a.textBaseline="top",r.forEach(function(r){a.fillText(n(r),t(r),e+6)})},LineChars.prototype.yAxis=function(){var e=this.height,t=this.y,a=this.context,r=t.ticks(10),n=t.tickFormat(10);a.beginPath(),r.forEach(function(e){a.moveTo(0,t(e)),a.lineTo(-6,t(e))}),a.strokeStyle="black",a.stroke(),a.beginPath(),a.moveTo(-6,0),a.lineTo(.5,0),a.lineTo(.5,e),a.lineTo(-6,e),a.strokeStyle="black",a.stroke(),a.textAlign="right",a.textBaseline="middle",r.forEach(function(e){a.fillText(n(e),-9,t(e))}),a.save(),a.rotate(-Math.PI/2),a.textAlign="right",a.textBaseline="top",a.font="bold 10px sans-serif",a.fillText("Price (US$)",-10,10),a.restore()},LineChars.prototype.render=function(e){this.context.translate(this.margin.left,this.margin.top);var t=d3.timeParse("%d-%b-%y"),a=this.context;this.x.domain(d3.extent(e,function(e){return t(e.time)})),this.y.domain(d3.extent(e,function(e){return+e.cpu})),this.xAxis(),this.yAxis(),a.beginPath(),this.line(e),a.lineWidth=1.5,a.strokeStyle="steelblue",a.stroke(),$(this.canvas).appendTo(this.target)},BaseChart.prototype.init=function(e,t){this.target=e,this.context=e,t=t||{},this.width=t.width,this.height=t.height,this.margin=t.margin||0},BaseChart.prototype.empty=function(){var e=Date.now(),t=e-36e5,a=[{time:t,cpu:0},{time:e,cpu:1}],r=this.getXScale(a),n=this.getYScale(a),s=this.getXAxis(r),i=this.getYAxis(n),o=d3.select(this.target).append("svg").attr("width",this.width).attr("height",this.height);return o.append("g").attr("class","x axis").attr("transform","translate(0, "+(this.height-this.margin)+")").call(s),d3.selectAll(".x.axis .tick text").call(this.xAxisLabel,r),o.append("g").attr("class","y axis").attr("transform","translate("+this.margin+", 0)").call(i),o},TimeSeries.prototype=new BaseChart,TimeSeries.prototype.render=function(e){if(0===e.length)return this.empty();var t=this.getXScale(e),a=this.getYScale(e),r=this.getXAxis(t),n=this.getYAxis(a),s=this.lineGenerator(t,a),i=d3.select(this.target).append("svg").attr("width",this.width).attr("height",this.height);return i.append("g").attr("class","x axis").attr("transform","translate(0, "+(this.height-this.margin)+")").call(r),i.selectAll(".x.axis .tick text").call(this.xAxisLabel,t),i.append("g").attr("class","y axis").attr("transform","translate("+this.margin+", 0)").call(n),i.append("path").attr("d",s(e)),i.selectAll(".dot").data(e).enter().append("circle").attr("class","dot").attr("r",3.5).attr("cx",function(e){return t(e.time)}).attr("cy",function(e){return a(e.cpu)}).on("mouseover",function(e){d3.select(this).attr("r",5)}).on("mouseout",function(e){d3.select(this).attr("r",3.5)}),i},TimeSeries.prototype.getXScale=function(e){return d3.scaleTime().domain([e[0].time,e[e.length-1].time]).range([0+this.margin,this.width])},TimeSeries.prototype.getYScale=function(e){return d3.scaleLinear().range([this.height-this.margin,0]).domain([0,d3.max(e,function(e){return e.cpu})]).nice()},TimeSeries.prototype.getXAxis=function(e){return d3.axisBottom(e).ticks(d3.timeMinutes,15)},TimeSeries.prototype.getYAxis=function(e){return d3.axisLeft(e).ticks(6).tickFormat(d3.format(".0%"))},TimeSeries.prototype.lineGenerator=function(e,t){return d3.line().x(function(t){return e(t.time)}).y(function(e){return t(e.cpu)})},TimeSeries.prototype.xAxisLabel=function(e){var t=d3.time.format("%I:%M %p"),a=d3.time.format("%d %b");e.each(function(e){var r=d3.select(this);r.text();r.text(null).append("tspan").attr("x",0).text(t(e)),r.append("tspan").attr("x",0).attr("dy",13).text(a(e))})},SparkLine.prototype=new TimeSeries,SparkLine.prototype.getXScale=function(e){return d3.scaleTime().domain([e[0].time,e[e.length-1].time]).range([0,this.width])},SparkLine.prototype.getYScale=function(e){return d3.scaleLinear().range([this.height,0]).domain(d3.extent(e,function(e){return e.cpu}))},SparkLine.prototype.render=function(e){var t=this.getXScale(e),a=this.getYScale(e),r=(this.getXAxis(t),this.getYAxis(a),this.lineGenerator(t,a));return d3.select(this.target).append("svg").attr("width",this.width).attr("height",this.height).append("path").datum(e).attr("class","sparkline").attr("d",r(e))},app.factory("TimeSeriesChart",function(){return{getChart:function(e,t){return new LineChars(e,t)}}}).factory("SparkLineChart",function(){return{getChart:function(e,t){return new SparkLine(e,t)}}}),app.factory("BarCharts",function(){return function(){return{key:"key",val:"count",width:400,height:280,num:0,colors:["#92A2A8"],margin:{top:5,right:5,bottom:5,left:5},showX:!1,showY:!1,title:"",legend:"",xRotate:null,draw:function(e,t){var a=this.key,r=this.val,n=this.width,s=this.height,i=this.num,o=this.colors,l=this.margin,c=this.legend;d3.select("#bar_"+i).remove(),d3.select(e).append("div").attr("id","bar_"+i).attr("class","hs_bar");var d="#bar_"+i;if(null!==this.title&&""!==$.trim(this.title)){var p=d3.select(d).append("div").attr("class","hs_charts_title").text(this.title);s=s-p.style("height").substring(0,p.style("height").indexOf("px"))-5}if(this.showY){var u=0,f=0;for(var h in t)f=t[h][r].toString().length,u=u<f?f:u;l.left+=8*u+10}var m=0;if(this.showX){var g=0,y=0;for(var v in t)y=t[v][a].toString().length,g=g<y?y:g;m=6*g,m=m<25?25:m}var w=d3.scaleOrdinal().range(o);if(null!=c&&""!=c&&"none"!=c){var b=(d3.select(d).append("div").attr("class","panel_bar_desc").attr("id","bar_desc_"+i),d3.select("#bar_desc_"+i).append("div:ul").attr("class","panel_bar_desc_"+i+" hs_charts_desc_ul"));b.selectAll("ul.panel_bar_desc_"+i).data(t).enter().append("ul.panel_bar_desc_"+i+":li").attr("class","icon-circle hs_left hs_charts_desc_ul_li").style("color",function(e,t){return w(t)}).text(function(e,t){return e[a]+" ("+e[r]+") "}),s=s-b.style("height").substring(0,b.style("height").indexOf("px"))-5}"below"==c&&desc.remove();var k=n-l.left-l.right,_=s-l.top-l.bottom;this.showX&&(_-=m/2);var U=d3.select(d).append("svg:svg").attr("width","100%").attr("height",s).attr("id","bar_charts_"+i),T=d3.scaleBand().range(t.length).round([0,k],.1),x=d3.scaleLinear().domain([0,d3.max(t,function(e){return e[r]})]).range([_,0]),C=d3.select("#bar_charts_"+i).append("svg:g").attr("class","panel_bar_"+i).attr("transform","translate("+l.left+","+l.top+")");C.selectAll("g.panel_bar_"+i).data(t).enter().append("svg:g").attr("class","bar");if($(function(){}),this.showX){var S=d3.svg.axis().scale(T).orient("bottom").tickFormat(function(e){return t[e][a]}),F=U.append("g").attr("class","hs_charts_x_axis").attr("transform","translate("+l.left+","+(_+l.top)+")").call(S);this.xRotate&&F.selectAll("text").attr("transform","translate(0,"+m/(90/this.xRotate)/2+"),rotate(-"+this.xRotate+")")}if(this.showY){var D=d3.svg.axis().scale(x).orient("left").ticks(5);U.append("g").attr("class","hs_charts_y_axis").attr("transform","translate("+l.left+","+l.top+")").call(D)}if("below"==c){d3.select(d).append("div").attr("class","panel_bar_desc").attr("id","bar_desc_"+i);d3.select("#bar_desc_"+i).append("div:ul").attr("class","panel_bar_desc_"+i+" hs_charts_desc_ul").selectAll("ul.panel_bar_desc_"+i).data(t).enter().append("ul.panel_bar_desc_"+i+":li").attr("class","icon-circle hs_left hs_charts_desc_ul_li").style("color",function(e,t){return w(t)}).text(function(e,t){return e[a]+" ("+e[r]+") "})}d3.select(d).append("div").attr("id","bar_popup_"+i).attr("class","hs_hide")}}}}),app.factory("PieCharts",function(){return function(){return{key:"key",val:"count",width:400,height:280,num:0,colors:["#92A2A8"],margin:{top:5,right:5,bottom:5,left:5},title:"",legend:"",draw:function(e,t){var a=this.key,r=this.val,n=this.width,s=this.height,i=this.num,o=this.colors,l=this.margin,c=this.legend;d3.select("#pie_"+i).remove(),d3.select(e).append("div").attr("id","pie_"+i).attr("class","hs_pie");var d="#pie_"+i;if(null!=this.title&&""!=$.trim(this.title)){var p=d3.select(d).append("div").attr("class","hs_charts_title").text(this.title);s=s-p.style("height").substring(0,p.style("height").indexOf("px"))-5}var u=d3.scaleOrdinal().range(o);if(null!=c&&""!=c&&"none"!=c){var f=(d3.select(d).append("div").attr("class","panel_pie_desc").attr("id","pie_desc_"+i),d3.select("#pie_desc_"+i).append("div:ul").attr("class","panel_pie_desc_"+i+" hs_charts_desc_ul"));f.selectAll("ul.panel_pie_desc_"+i).data(t).enter().append("ul.panel_pie_desc_"+i+":li").attr("class","icon-circle hs_left hs_charts_desc_ul_li").style("color",function(e,t){return u(t)}).text(function(e,t){return e[a]+" ("+e[r]+") "}),s=s-f.style("height").substring(0,f.style("height").indexOf("px"))-5}"below"==c&&desc.remove();var h=n-l.left-l.right,m=s-l.top-l.bottom,g=Math.min(h,m)/2,y=d3.arc().outerRadius(g-10).innerRadius(0),v=d3.pie().sort(null).value(function(e){return e[r]}),w=d3.select(d).append("svg").attr("width",h).attr("height",m).append("g").attr("transform","translate("+h/2+","+m/2+")");t.forEach(function(e){e[r]=+e[r]});var b=d3.sum(t,function(e){return e[r]}),k=w.selectAll(".arc").data(v(t)).enter().append("g").attr("class","arc");if(k.append("path").attr("d",y).attr("class","field_charts_point_"+i+" hs_pie_alt").style("fill",function(e,t){return u(t)}).style("stroke","#FFFFFF").on("mouseover",function(e,t){d3.select("#pie_popup_"+i).html(function(){return e.data[a]+"<br/>"+d3.format("d")(e.data[r]/b*100,1)+"%"}).style("left",d3.event.pageX-$("#pie_"+i).offset().left+"px").style("top",d3.event.pageY-$("#pie_"+i).offset().top-$("#pie_"+i).height()-l.top-l.bottom+"px").attr("class","hs_pie_popup")}).on("mousemove",function(e,t){d3.select("#pie_popup_"+i).html(function(){return e.data[a]+"<br/>"+d3.format("d")(e.data[r]/b*100,1)+"%"}).style("left",d3.event.pageX-$("#pie_"+i).offset().left+"px").style("top",d3.event.pageY-$("#pie_"+i).offset().top-$("#pie_"+i).height()-l.top-l.bottom+"px").attr("class","hs_pie_popup")}).on("mouseout",function(e,t){d3.select("#pie_popup_"+i).on("mouseover",function(e,t){$(this).attr("class","hs_pie_popup")}).on("mouseout",function(e,t){$(this).attr("class","hs_hide")}).attr("class","hs_hide")}),k.append("text").attr("transform",function(e){return"translate("+y.centroid(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(e){var t=e.data[r]/b*100;if(t>=5)return d3.format("d")(t,1)+"%"}),$(function(){}),"below"==c){d3.select(d).append("div").attr("class","panel_pie_desc").attr("id","pie_desc_"+i);d3.select("#pie_desc_"+i).append("div:ul").attr("class","panel_pie_desc_"+i+" hs_charts_desc_ul").selectAll("ul.panel_pie_desc_"+i).data(t).enter().append("ul.panel_pie_desc_"+i+":li").attr("class","icon-circle hs_left hs_charts_desc_ul_li").style("color",function(e,t){return u(t)}).text(function(e,t){return e[a]+" ("+e[r]+") "})}d3.select(d).append("div").attr("id","pie_popup_"+i).attr("class","hs_hide")}}}}),app.factory("SparkLineCharts",function(){return function(){return{key:"key",val:"count",width:400,height:280,num:0,colors:["#92A2A8"],margin:{top:5,right:5,bottom:5,left:5},showX:!1,showY:!1,title:"",legend:"",xRotate:null,draw:function(e,t){var a=this.key,r=this.val,n=this.width,s=this.height,i=this.num,o=this.colors,l=this.margin,c=this.legend,d=d3.scale.ordinal().range(o);d.domain(d3.keys(t[0]).filter(function(e){return"key"!==e}));var p="#sparkline_"+i;if(d3.select(p)&&d3.select(p).remove(),d3.select(e).append("div").attr("id","sparkline_"+i).attr("class","hs_sparklineCharts"),null!=this.title&&""!=$.trim(this.title)){var u=d3.select(p).append("div").attr("class","hs_charts_title").text(this.title);s=s-u.style("height").substring(0,u.style("height").indexOf("px"))-5}if(this.showY){var f=0,h=0;for(var m in t)h=t[m][r].toString().length,f=f<h?h:f;l.left+=8*f+10}var g=0;if(this.showX){var y=0,v=0;for(var w in t)v=t[w][a].toString().length,y=y<v?v:y;g=6*y,g=g<25?25:g}if(null!==c&&""!==c&&"none"!==c){var b=(d3.select(p).append("div").attr("class","panel_sparkline_desc").attr("id","sparkline_desc_"+i),d3.select("#sparkline_desc_"+i).append("div:ul").attr("class","panel_sparkline_desc_"+i+" hs_charts_desc_ul"));b.selectAll("ul.panel_sparkline_desc_"+i).data(t).enter().append("ul.panel_sparkline_desc_"+i+":li").attr("class","icon-circle hs_left hs_charts_desc_ul_li").style("color",function(e,t){return d(t)}).text(function(e,t){return e[a]+" ("+e[r]+") "}),s=s-b.style("height").substring(0,b.style("height").indexOf("px"))-5}"below"==c&&desc.remove();var k=n-l.left-l.right,_=s-l.top-l.bottom;this.showX&&(_-=g/2);var U=d3.scale.ordinal().domain(d3.range(t.length)).rangeRoundBands([0,k]),T=d3.scale.linear().domain([0,d3.max(t,function(e){return e[r]})]).range([_,0]),x=d3.select(p).append("svg:svg").attr("width","100%").attr("height",s).attr("id","sparkline_charts_"+i),C=d.domain().map(function(e){return{name:e,values:t.map(function(t){return{key:t.key,temperature:+t[e]}})}}),S=d3.svg.line().interpolate("linear").x(function(e,t){return U.rangeBand()*(t+.5)}).y(function(e){return T(e.temperature)});x.selectAll(".city").data(C).enter().append("g").attr("class","city").append("path").attr("class","line").attr("d",function(e){return S(e.values)}).style("stroke",function(e){return d(e.name)}).style("fill","none").attr("transform","translate("+l.left+","+l.top+")");for(var F=0;F<C.length;F++){var D=x.selectAll(".point").data(C[F].values).enter().append("svg:circle");D.attr("class","chart_point").attr("stroke",d(C[F].name)).attr("fill",d(C[F].name)).attr("cx",function(e,t){return U.rangeBand()*(t+.5)}).attr("cy",function(e,t){return T(e.temperature)}).attr("r",function(e,t){return 3}).attr("transform","translate("+l.left+","+l.top+")"),D.on("mouseover",function(e,t){return d3.select("#sparkline_popup_"+i).html(function(){return e.key+"<br/>"+e.temperature}).style("left",d3.event.pageX-$(p).offset().left+"px").style("top",d3.event.pageY-$(p).offset().top-$(p).height()-l.top-l.bottom+"px").attr("class","hs_sparkline_popup"),d3.select(this).attr("r",4)}).on("mouseout",function(e,t){return d3.select("#sparkline_popup_"+i).on("mouseover",function(e,t){$(this).attr("class","hs_sparkline_popup")}).on("mouseout",function(e,t){$(this).attr("class","hs_hide")}).attr("class","hs_hide"),d3.select(this).attr("r",3)})}if(this.showX){var A=d3.svg.axis().scale(U).orient("bottom").tickFormat(function(e){return t[e].key}),E=x.append("g").attr("class","hs_charts_x_axis").attr("transform","translate("+l.left+","+(_+l.top)+")").call(A);this.xRotate&&E.selectAll("text").attr("transform","translate(0,"+g/(90/this.xRotate)/2+"),rotate(-"+this.xRotate+")")}if(this.showY){var R=d3.svg.axis().scale(T).orient("left").ticks(5);x.append("g").attr("class","hs_charts_y_axis").attr("transform","translate("+l.left+","+l.top+")").call(R).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end")}if("below"===c){d3.select(p).append("div").attr("class","panel_sparkline_desc").attr("id","sparkline_desc_"+i);d3.select("#sparkline_desc_"+i).append("div:ul").attr("class","panel_sparkline_desc_"+i+" hs_charts_desc_ul").selectAll("ul.panel_sparkline_desc_"+i).data(t).enter().append("ul.panel_sparkline_desc_"+i+":li").attr("class","icon-circle hs_left hs_charts_desc_ul_li").style("color",function(e,t){return d(t)}).text(function(e,t){return e[a]+" ("+e[r]+") "})}d3.select(p).append("div").attr("id","sparkline_popup_"+i).attr("class","hs_hide")}}}}),app.factory("DataSource",["$resource",function(e){return e("/datasource/:id",{},{download:{method:"GET",responseType:"blob",transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}},byType:{method:"POST",url:"/datasource/type/:type",params:{type:"@type"},isArray:!0,timeout:5e3},preview:{method:"POST",url:"/datasource/preview",isArray:!0,timeout:5e3}})}]),app.factory("Channel",["$resource",function(e){return e("/config/:id",{},{download:{method:"GET",responseType:"blob",transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}},operate:{method:"PUT",url:"/config/:opt/:id",params:{opt:"@opt",id:"@id"},timeout:2e4},check:{method:"POST",url:"/usability",isArray:!0,timeout:2e4}})}]),app.service("Util",function(){this.resetFormValidateState=function(e){if(!e)return!1;e.$submitted=!1,angular.forEach(e,function(t,a){"$"!==a.substring(0,1)&&e[a].$dirty&&(e[a].$dirty=!1,e[a].$pristine=!0)})}}),app.factory("Knowledge",["$resource",function(e){return e("/knowledge/:id",{},{download:{method:"GET",responseType:"blob",transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}},operate:{method:"PUT",url:"/knowledge/:opt/:id",params:{opt:"@opt",id:"@id"}},queryByStatus:{method:"POST",url:"/knowledge/queryByStatus",isArray:!0}})}]),app.factory("KnowledgeInfo",["$resource",function(e){return e("/knowledgeInfo/:id",{},{})}]),app.factory("Analyzer",["$resource",function(e){return e("/analyzer/:id",{},{download:{method:"GET",responseType:"blob",transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}},preview:{method:"POST",url:"/analyzer/preview",timeout:2e4},queryByType:{method:"GET",url:"/analyzer/type",isArray:!0,timeout:2e4}})}]),app.factory("Dictionary",["$resource",function(e){return e("/dictionary/:id")}]),app.factory("Collector",["$resource",function(e){return e("/collector/:id")}]),app.factory("CollectorOpt",["$resource",function(e){return e("/collector/:id/:opt",{opt:"@opt",id:"@id"},{operate:{method:"PUT"}})}]),app.factory("Parser",["$resource",function(e){return e("/parser/:id",{},{download:{method:"GET",responseType:"blob",
transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}},properties:{method:"POST",url:"/previewer",isArray:!0,timeout:5e3},preview:{method:"POST",url:"/preview",isArray:!0,timeout:5e3}})}]),app.factory("Writer",["$resource",function(e){return e("/writer/:id",{},{download:{method:"GET",responseType:"blob",transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}}})}]),app.factory("Timer",["$resource",function(e){return e("/timer/:id",{},{download:{method:"GET",responseType:"blob",transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}}})}]),app.factory("TimerDepends",["$resource",function(e){return e("/timerDepends/:id",{},{download:{method:"GET",responseType:"blob",transformResponse:function(e){var t={};return t.data=e,t.headers={"Content-Disposition":"attachment"},t}}})}]),app.factory("Metrics",["$resource",function(e){return e("/metrics/:collector/:id",{id:"@id",collector:"@collector"},{query:{method:"GET",isArray:!1}})}]),app.factory("Modeling",["$resource",function(e){return e("/modeling/:id",{},{download:{method:"GET",transformResponse:function(e){var t=JSON.parse(e);t.jobId&&delete t.jobId;var a={},r=new Blob([JSON.stringify(t)],{type:"application/json"});return a.data=r,a.headers={"Content-Disposition":"attachment"},a}},operate:{method:"PUT",url:"/modeling/:opt/:id",params:{opt:"@opt",id:"@id"},timeout:2e4},check:{method:"POST",url:"/usability",isArray:!0,timeout:2e4},connectTest:{method:"POST",url:"/modeling/check",timeout:2e4},queryByType:{method:"GET",url:"/modeling/type/:type",isArray:!0,timeout:2e4}})}]),app.service("Util",function(){this.resetFormValidateState=function(e){if(!e)return!1;e.$submitted=!1,angular.forEach(e,function(t,a){"$"!==a.substring(0,1)&&e[a].$dirty&&(e[a].$dirty=!1,e[a].$pristine=!0)})}}),app.controller("ChannelController",["$scope","$rootScope","$timeout","$location","Channel","Modeling","Analyzer","Util","DataSource","Metrics","Collector","Parser","Writer",function($scope,$rootScope,$timeout,$location,Channel,Modeling,Analyzer,Util,DataSource,Metrics,Collector,Parser,Writer){function getWriterNameById(e){var t={};return $scope.writers.forEach(function(e){t[e.id]=e.name}),t[e]?t[e]:e}function metricsOne(e,t,a){$scope.data=[];var r="";"parser"==$scope.channel.type.name&&(r="解析"),"analyzer"==$scope.channel.type.name&&(r="分析"),Channel.get({id:e},function(e){$scope.options.title.text=e.name,$scope.options.subtitle.html="从【"+t+"】到 【"+a+"】",Metrics.query({collector:e.collector,id:e.id,from:t,to:a,interval:$scope.metric.interval},function(e){var n=e.info,s=[{x:d3.time.format("%Y-%m-%d %H:%M:%S").parse(t)},{x:d3.time.format("%Y-%m-%d %H:%M:%S").parse(a)}],i=s.concat([]),o=s.concat([]),l=s.concat([]),c=s.concat([]),d={},p={read:{success:0,fail:0,ignore:0},operation:{success:0,fail:0,ignore:0},writes:{}};if(!n.status){n.forEach(function(e){var t=d3.time.format("%Y-%m-%d %H:%M:%S").parse(e.lasttime);if("SUCCESS"==e.metricType&&"READ"==e.metricPhase&&i.push({x:t,y:e.metric["1-minute rate"]}),"SUCCESS"==e.metricType&&"OPERATION"==e.metricPhase&&o.push({x:t,y:e.metric["1-minute rate"]}),"FAIL"==e.metricType&&"OPERATION"==e.metricPhase&&l.push({x:t,y:e.metric["1-minute rate"]}),"IGNORE"==e.metricType&&"OPERATION"==e.metricPhase&&c.push({x:t,y:e.metric["1-minute rate"]}),"SUCCESS"==e.metricType&&"WRITE"==e.metricPhase&&-1==e.metricId.indexOf("forward")){var a=getWriterNameById(e.metricId.split("@")[0]);d[a]||(d[a]=s.concat([])),d[a].push({x:t,y:e.metric["1-minute rate"]})}});for(var u in e.count)if(-1!=u.indexOf("read_success"))p.read.success=e.count[u];else if(-1!=u.indexOf("operation_success"))p.operation.success=e.count[u];else if(-1!=u.indexOf("operation_fail"))p.operation.fail=e.count[u];else if(-1!=u.indexOf("operation_ignore"))p.operation.ignore=e.count[u];else if(-1!=u.indexOf("write_success")&&-1==u.indexOf("forward")){var f=getWriterNameById(u.split("@")[0]);p.writes[f]?p.writes[f].success=e.count[u]:p.writes[f]={success:e.count[u]}}else if(-1!=u.indexOf("write_fail")&&-1==u.indexOf("forward")){var f=getWriterNameById(u.split("@")[0]);p.writes[f]?p.writes[f].fail=e.count[u]:p.writes[f]={fail:e.count[u]}}if($scope.countMessage=p,i.length>0){$scope.data.push({key:"读取成功",values:i}),$scope.data.push({key:r+"成功",values:o}),$scope.data.push({key:r+"失败",values:l}),$scope.data.push({key:r+"忽略",values:c});for(u in d)$scope.data.push({key:u+"-输出成功",values:d[u]})}}})})}function PropertiesWithType(){var reg=/^(true)|(false)|\d+$/;for(var item in $scope.channel.properties){var v=$scope.channel.properties[item];v&&reg.test(v)&&($scope.channel.properties[item]=eval(v))}}function setWriterForViewer(e){if($scope.writers.$resolved){var t=new Array($scope.writers.length);if(e)for(var a=0,r=e.length;a<r;a++){var n=e[a];if(n){var s=function(e){for(var t=[],a=0,r=$scope.writers.length;a<r;a++)if($scope.writers[a].id==e){t=[a,$scope.writers[a]];break}return t}(n);2==s.length&&(t[s[0]]={id:s[1].id,name:s[1].name})}}$scope.channel.writers=t}}function setForSave(e){return(e||[]).filter(function(e){return null!=e&&void 0!=e}).map(function(e){return console.log(e),e.id})}$rootScope.$path=$location.path.bind($location),$scope.encodings=["UTF-8","GBK","GB18030","GB2312","BIG5","UNICODE","ASCII","ISO-8859-1"];var $confirmModal=$("#confirmModal");$scope.countMessage="采集的总量：未知";var d3_format=d3.time.format("%Y-%m-%d %H:%M:%S"),days=36e5,defaultChannel={type:{name:"parser"},properties:{timeout_ms:100,polling_ms:1e3},writers:[]};$scope.channel=defaultChannel,$scope.collectors=Collector.query(),$scope.datasources=DataSource.byType({type:"default"});var defaultChannels=DataSource.byType({type:"channel"});$scope.channels=defaultChannels,$scope.resolvers=Parser.query(),$scope.resolverList=$scope.resolvers,$scope.analyzers=Analyzer.query(),$scope.datasource={},$scope.changeDataSourceType=function(e){DataSource.get({id:e},function(e){$scope.datasource=e})},$scope.connectTest=function(e){var t=$scope.channel.collector,a=$scope.channel.type.cluster;e&&(angular.element("#connect_test").html('<i class="fa fa-spinner fa-spin"></i>'),Modeling.connectTest({opt:"check",workerId:t,url:a},function(e){$scope.message=e,angular.element("#connect_test").html("测试连接")},function(e){$scope.message={message:"Connect to server has timed out, please try again later."},angular.element("#connect_test").html("测试连接")}))},$scope.writers=Writer.query(),$scope.options={chart:{type:"lineChart",height:450,margin:{top:20,right:20,bottom:40,left:55},x:function(e){return e.x},y:function(e){return e.y},useInteractiveGuideline:!0,dispatch:{stateChange:function(e){console.log("stateChange")},changeState:function(e){console.log("changeState")},tooltipShow:function(e){console.log("tooltipShow")},tooltipHide:function(e){console.log("tooltipHide")}},xAxis:{axisLabel:"时间",tickFormat:function(e){return d3.time.format("%d日%H:%M:%S")(new Date(e))}},yAxis:{axisLabel:"条数/秒",tickFormat:function(e){return e},axisLabelDistance:-10},callback:function(e){console.log("!!! lineChart callback !!!")}},title:{enable:!0,text:"采集进度"},subtitle:{enable:!0,text:"采集时间范围",css:{"text-align":"center",margin:"10px 13px 0px 7px"}},caption:{html:" ",enable:!0,css:{"text-align":"justify",margin:"10px 13px 0px 7px"}}},$scope.usableCheck=function(){var e=angular.copy($scope.channel);e.writers=setForSave(e.writers),Channel.check(e,function(e){$scope.rt=e})},$scope.metric={interval:5,format:"yyyy-MM-dd HH:mm:ss",altInputFormats:["yyyy/M!/d!"],popup1:{opened:!1},open1:function(){this.popup1.opened=!0},popup2:{opened:!1},open2:function(){this.popup2.opened=!0}},$scope.metrics=function(e){var t=new Date,a=d3_format(new Date(t.getTime()-days)),r=d3_format(t);$scope.metric.startTime=a,$scope.metric.endTime=r,$scope.metric.dsId=e,metricsOne(e,a,r)},$scope.udMetrics=function(){var e=d3_format.parse($scope.metric.startTime),t=d3_format.parse($scope.metric.endTime);return e>t?($scope.options.subtitle.html="<span style='color:rgba(255,0,0,0)'>时间选择错误：开始时间晚于结束时间！</span>",void($scope.message={message:"时间选择错误：开始时间晚于结束时间！"})):e.getTime()+6048e5<t.getTime()?($scope.options.subtitle.html="<span style='color:rgba(255,0,0,0)'>时间选择错误：只提供7日内计量信息查询！</span>",void($scope.message={message:"时间选择错误：只提供7日内计量信息查询"})):($scope.message="",void metricsOne($scope.metric.dsId,$scope.metric.startTime,$scope.metric.endTime))},$scope.resetForm=function(){$scope.channel=defaultChannel,Util.resetFormValidateState($scope.ds_form)},$scope.resetForm(),$scope.save=function(e){if(!e)return!1;var t=angular.copy($scope.channel);t.writers=setForSave(t.writers),Channel.save(t,function(e){$scope.message=e,"200"==$scope.message.status&&($scope.reload(),$scope.show(),$(".hla-widget-add-table").slideUp())})},$scope.uploadFile=function(){delete $scope.message;var e=$(".hla-widget-add-table"),t=$(".hla-widget-search-table"),a=$(".hla-widget-upload-table"),r=$scope.myFile,n=new FileReader;n.onload=function(r){return function(r){$scope.channel=angular.fromJson(this.result),delete $scope.channel.id,0==$scope.collectors.filter(function(e){return e.id==$scope.channel.collectorId}).length&&delete $scope.channel.collectorId,delete $scope.channel.status,delete $scope.channel.datatime,setWriterForViewer(angular.copy($scope.channel.writers)),e.slideDown(),t.slideUp(),a.slideUp(),delete $scope.myFile,$scope.$apply()}}();try{n.readAsText(r)}catch(e){$scope.message={status:"500",message:"数据解析出错,你检查你的数据文件是否正确!"}}},$scope.show=function(e,t){var a=$(".hla-widget-add-table"),r=$(".hla-widget-search-table"),n=$(".hla-widget-upload-table"),s=$(".hla-widget-metric-table");switch(Util.resetFormValidateState($scope.ds_form),e){case"upload":delete $scope.message,a.slideUp(),r.slideUp(),s.slideUp(),n.slideToggle();break;case"search":delete $scope.message,a.slideUp(),r.slideToggle(),s.slideUp(),n.slideUp();break;case"add":delete $scope.message,a.slideToggle(),r.slideUp(),s.slideUp(),n.slideUp(),$scope.resetForm();break;case"metric-parser":delete $scope.message,$scope.channel.type.name="parser",$scope.metrics(t),a.slideUp(),r.slideUp(),s.slideDown(),n.slideUp();break;case"metric-analyzer":delete $scope.message,$scope.channel.type.name="analyzer",$scope.metrics(t),a.slideUp(),r.slideUp(),s.slideDown(),n.slideUp();break;case"edit":delete $scope.message,Channel.get({id:t},function(e){$scope.channel=e,"parser"===$scope.channel.type.name?0===$scope.datasources.filter(function(e){return e.id===$scope.channel.datasource}).length&&delete $scope.channel.datasource:($scope.channels=defaultChannels.filter(function(e){return e.id!==$scope.channel.id}),0===$scope.channels.filter(function(e){return e.id===$scope.channel.datasource}).length&&delete $scope.channel.datasource),0===$scope.collectors.filter(function(e){return e.id===$scope.channel.collector}).length&&delete $scope.channel.collector,0===$scope.resolvers.filter(function(e){return e.id===$scope.channel.parser}).length&&0===$scope.analyzers.filter(function(e){return e.id===$scope.channel.parser}).length&&delete $scope.channel.parser,setWriterForViewer(angular.copy(e.writers)),PropertiesWithType(),n.slideUp(),a.slideDown(),s.slideUp(),r.slideUp()});break;case"copy":delete $scope.message,Channel.get({id:t},function(e){$scope.channel=e,console.log($scope.channel.properties.collector_info),console.log($scope.channel.properties.receive_time),$scope.channel.name=$scope.channel.name+"_copy",delete $scope.channel.id,delete $scope.channel.status,delete $scope.channel.datatime,setWriterForViewer(angular.copy(e.writers)),PropertiesWithType(),a.slideDown(),r.slideUp(),s.slideUp(),n.slideUp()});break;default:a.slideUp(),r.slideUp(),s.slideUp(),n.slideUp()}},$scope.operate=function(e,t){Channel.operate({opt:e,id:t},function(e){$scope.message=e,$scope.reload()},function(e){var t="";t=500==e.status?e.data:-1==e.status?"Connect to server has timed out, please try again later.":"Others exception.";var a={message:t};$scope.message=a})},$scope.delete=function(e){$scope.deleteId=e,$confirmModal.modal("show")},$scope.confirm_yes=function(){Channel.delete({id:$scope.deleteId},function(e){$scope.message=e,$scope.reload()}),$confirmModal.modal("hide")},$confirmModal.find(".op_yes").off().click(function(){$scope.confirm_yes()}),$scope.reload=function(){$scope.list=Channel.get($scope.page,function(e){e.result.length>0?e.result=e.result.map(function(e){return e}):e.result=[]})},$scope.addHostPort=function(){var e=$scope.channel.data.hostPorts;e||(e=$scope.channel.data.hostPorts=[]),e.push(["",9300])},$scope.removeHostPort=function(e){$scope.channel.data.hostPorts.splice(e,1)},$scope.addHostEncoding=function(){var e=$scope.channel.data.listens;e||(e=$scope.channel.data.listens=[]),e.push(["",""])},$scope.removeHostEncoding=function(e){$scope.channel.data.listens.splice(e,1)},$scope.changeDBType=function(){var e=$scope.channel.data.protocol,t=null;switch(e){case"mysql":t=3306;break;case"oracle":t=1521;break;case"sqlserver":t=1433;break;case"DB2":t=5e4;break;case"sybase":t=5e3;break;case"postgresql":t=5432;break;case"sqlite":t=0;break;case"derby":t=1527}$scope.channel.data.port=t},$scope.downloadFile=function(e){Channel.download({id:e},function(t){var a="数据通道配置";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})}}]),app.controller("KnowledgeController",["$scope","$rootScope","$location","Knowledge","Util","DataSource","Metrics","Collector","Parser",function(e,t,a,r,n,s,i,o,l){t.$path=a.path.bind(a),e.encodings=["UTF-8","GBK","GB18030","GB2312","BIG5","UNICODE","ASCII","ISO-8859-1"];var c=$("#confirmModal");e.countMessage="采集的总量：未知";var d=(d3.time.format("%Y-%m-%d %H:%M:%S"),{name:"",collector:"",datasource:"",parser:""});e.collectors=o.query(),e.datasources=s.query(),e.knowledges=r.query(),e.resolvers=l.query(),e.resolverList=e.resolvers,e.options={chart:{type:"lineChart",height:450,margin:{top:20,right:20,bottom:40,left:55},x:function(e){return e.x},y:function(e){return e.y},useInteractiveGuideline:!0,dispatch:{stateChange:function(e){console.log("stateChange")},changeState:function(e){console.log("changeState")},tooltipShow:function(e){console.log("tooltipShow")},tooltipHide:function(e){console.log("tooltipHide")}},xAxis:{axisLabel:"时间(ms)",tickFormat:function(e){return d3.time.format("%H:%M:%S")(new Date(e))}},yAxis:{axisLabel:"条数/秒",tickFormat:function(e){return e},axisLabelDistance:-10},callback:function(e){console.log("!!! lineChart callback !!!")}},title:{enable:!0,text:"采集进度"},subtitle:{enable:!0,text:"采集时间范围",css:{"text-align":"center",margin:"10px 13px 0px 7px"}},caption:{html:" ",enable:!0,css:{"text-align":"justify",margin:"10px 13px 0px 7px"}}},e.resetForm=function(){e.knowledge=angular.copy(d),n.resetFormValidateState(e.ds_form)},e.resetForm(),e.save=function(t){if(!t)return!1;var a=angular.copy(e.knowledge);r.save(a,function(t){e.message=t,"200"==e.message.status&&(e.reload(),e.show(),$(".hla-widget-add-table").slideUp())})},e.uploadFile=function(){delete e.message;var t=$(".hla-widget-add-table"),a=$(".hla-widget-search-table"),r=$(".hla-widget-upload-table"),n=e.myFile,s=new FileReader;s.onload=function(n){return function(n){e.knowledge=angular.fromJson(this.result),delete e.knowledge.id,0==e.collectors.filter(function(t){return t.id==e.knowledge.collector}).length&&delete e.knowledge.collector,0==e.datasources.filter(function(t){return t.id==e.knowledge.datasource}).length&&delete e.knowledge.datasource,0==e.resolvers.filter(function(t){return t.id==e.knowledge.parser}).length&&delete e.knowledge.parser,delete e.knowledge.status,delete e.knowledge.datatime,t.slideDown(),a.slideUp(),r.slideUp(),delete e.myFile,e.$apply()}}();try{s.readAsText(n)}catch(t){e.message={status:"500",message:"数据解析出错,你检查你的数据文件是否正确!"}}},e.show=function(t,a){var s=$(".hla-widget-add-table"),i=$(".hla-widget-search-table"),o=$(".hla-widget-upload-table");switch(n.resetFormValidateState(e.ds_form),t){case"upload":delete e.message,s.slideUp(),i.slideUp(),o.slideToggle();break;case"search":delete e.message,s.slideUp(),i.slideToggle(),o.slideUp();break;case"add":delete e.message,s.slideToggle(),i.slideUp(),o.slideUp(),e.resetForm();break;case"edit":delete e.message,r.get({id:a},function(t){e.knowledge=t,o.slideUp(),s.slideDown(),i.slideUp()});break;case"copy":delete e.message,console.log(a),r.get({id:a},function(t){e.knowledge=t,e.knowledge.name=e.knowledge.name+"_copy",delete e.knowledge.id,delete e.knowledge.status,delete e.knowledge.datatime,s.slideDown(),i.slideUp(),o.slideUp()});break;default:s.slideUp(),i.slideUp(),o.slideUp()}},e.operate=function(t,a){r.operate({opt:t,id:a},function(t){e.message=t,e.reload()})},e.delete=function(t){e.deleteId=t,c.modal("show")},e.confirm_yes=function(){r.delete({id:e.deleteId},function(t){e.message=t,e.reload()}),c.modal("hide")},c.find(".op_yes").off().click(function(){e.confirm_yes()}),e.reload=function(){e.list=r.get(e.page,function(t){t.result.length>0?(t.result=t.result.map(function(e){return e}),e.page.count=e.list.totalCount,e.page.limit=e.list.limit,e.page.total=e.list.totalPage):t.result=[]})},e.addHostPort=function(){var t=e.knowledge.data.hostPorts;t||(t=e.knowledge.data.hostPorts=[]),t.push(["",9300])},e.removeHostPort=function(t){e.knowledge.data.hostPorts.splice(t,1)},e.addHostEncoding=function(){var t=e.knowledge.data.listens;t||(t=e.knowledge.data.listens=[]),t.push(["",""])},e.removeHostEncoding=function(t){e.knowledge.data.listens.splice(t,1)},e.changeDBType=function(){var t=e.knowledge.data.protocol,a=null;switch(t){case"mysql":a=3306;break;case"oracle":a=1521;break;case"sqlserver":a=1433;break;case"DB2":a=5e4;break;case"sybase":a=5e3;break;case"postgresql":a=5432;break;case"sqlite":a=0;break;case"derby":a=1527}e.knowledge.data.port=a},e.downloadFile=function(e){r.download({id:e},function(t){var a="知识库配置";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})}}]),app.controller("KnowledgeInfoController",["$scope","$rootScope","$location","Util","Knowledge","KnowledgeInfo","Modeling",function(e,t,a,r,n,s,i){t.$path=a.path.bind(a),e.encodings=["UTF-8","GBK","GB18030","GB2312","BIG5","UNICODE","ASCII","ISO-8859-1"];$("#confirmModal");e.knowledges=[],n.queryByStatus(function(t){t.map(function(t){e.knowledges.push(t)})}),e.modelings=i.queryByType({type:"model"},function(t){t.map(function(t){e.knowledges.push(t)})}),e.tableTheads=[],e.reload=function(){e.tableTheads=[],e.list=s.get(e.page,function(t){if(t.result.length>0){t.result=t.result.map(function(e){return e});for(var a in t.result[0])e.tableTheads.push(a);e.page.count=e.list.totalCount,e.page.limit=e.list.limit,e.page.total=e.list.totalPage}else t.result=[]})},$(".hla-widget-search-table").slideToggle()}]),app.controller("DataSourceController",["$scope","$rootScope","$location","Util","DataSource","Collector","Parser",function(e,t,a,r,n,s,i){t.$path=a.path.bind(a),e.encodings=["UTF-8","GBK","GB18030","GB2312","BIG5","UNICODE","ASCII","ISO-8859-1"],e.isHaveThead=!0;var o=$("#confirmModal");e.previewData={},e.collectors=s.query(),e.parsers=i.query(),e.channels=n.byType({type:"channel"});var l={properties:{polling_ms:"1000",timeout_ms:"100",connectTimeout:"300"},data:{name:"file",contentType:{name:"txt"},position:"END",skipLine:0,protocol:{name:"net",protocol:{name:"udp"}},cache:1e3,codec:{name:"line"},metadata:{timestamp:"@timestamp"},authorization:!1,properties:{connectTimeout:"300"}}};e.options={chart:{type:"lineChart",height:450,margin:{top:20,right:20,bottom:40,left:55},x:function(e){return e.x},y:function(e){return e.y},useInteractiveGuideline:!0,dispatch:{stateChange:function(e){console.log("stateChange")},changeState:function(e){console.log("changeState")},tooltipShow:function(e){console.log("tooltipShow")},tooltipHide:function(e){console.log("tooltipHide")}},xAxis:{axisLabel:"时间(ms)",tickFormat:function(e){return d3.time.format("%H:%M:%S")(new Date(e))}},yAxis:{axisLabel:"条数/秒",tickFormat:function(e){return e},axisLabelDistance:-10},callback:function(e){console.log("!!! lineChart callback !!!")}},title:{enable:!0,text:"采集进度"},subtitle:{enable:!0,text:"采集时间范围",css:{"text-align":"center",margin:"10px 13px 0px 7px"}},caption:{html:"采集的总量：未知",enable:!0,css:{"text-align":"justify",margin:"10px 13px 0px 7px"}}},e.preview=function(t){if(console.log(e.datasource),!t)return!1;n.preview(e.datasource,function(t){e.previewData=t,e.showPreview=!0})},e.resetForm=function(){e.datasource=angular.copy(l),r.resetFormValidateState(e.ds_form)},e.resetForm(),e.saveDataSource=function(t){if(!t)return!1;var a=angular.copy(e.datasource);delete a.data.uri,n.save(a,function(t){e.message=t,"200"==e.message.status&&(e.reload(),e.show(),$(".hla-widget-add-table").slideUp(),e.reload())})},e.deleteHeader=function(){var t=e.datasource.data.contentType&&e.datasource.data.contentType;!t.isHaveThead||!0!==t.isHaveThead&&"true"!==t.isHaveThead||delete t.header;var a=e.datasource.data.path&&e.datasource.data.path.contentType&&e.datasource.data.path.contentType;!a.isHaveThead||!0!==a.isHaveThead&&"true"!==a.isHaveThead||delete a.header},e.uploadFile=function(){delete e.message;var t=$(".hla-widget-add-table"),a=$(".hla-widget-search-table"),r=$(".hla-widget-upload-table"),n=e.myFile,s=new FileReader;s.onload=function(n){return function(n){e.datasource=angular.fromJson(this.result),delete e.datasource.id,delete e.datasource.status,delete e.datasource.datatime,t.slideDown(),a.slideUp(),r.slideUp(),delete e.myFile,e.$apply()}}();try{s.readAsText(n)}catch(t){e.message={status:"500",message:"数据解析出错,你检查你的数据文件是否正确!"}}},e.show=function(t,a){var s=$(".hla-widget-add-table"),i=$(".hla-widget-search-table"),o=$(".hla-widget-upload-table"),l=$(".hla-widget-metric-table");switch(r.resetFormValidateState(e.ds_form),e.channels=n.byType({type:"channel"}),t){case"upload":delete e.message,s.slideUp(),i.slideUp(),l.slideUp(),o.slideToggle(),$(".fileinput-remove").trigger("click");break;case"search":delete e.message,s.slideUp(),i.slideToggle(),l.slideUp(),o.slideUp();break;case"add":delete e.message,s.slideToggle(),i.slideUp(),l.slideUp(),o.slideUp(),e.resetForm();break;case"edit":delete e.message,n.get({id:a},function(t){e.datasource=t,e.datasource.data.properties&&e.datasource.data.properties.fromstart&&(e.datasource.data.properties.fromstart=!!e.datasource.data.properties.fromstart&&"true"==e.datasource.data.properties.fromstart),e.channels=e.channels.filter(function(e){return e.id!==a}),o.slideUp(),s.slideDown(),l.slideUp(),i.slideUp()});break;case"copy":delete e.message,n.get({id:a},function(t){e.datasource=t,e.datasource.name=e.datasource.name+"_copy",delete e.datasource.id,delete e.datasource.status,delete e.datasource.datatime,s.slideDown(),i.slideUp(),l.slideUp(),o.slideUp()});break;default:s.slideUp(),i.slideUp(),l.slideUp(),o.slideUp()}},e.delete=function(t){e.deleteId=t,o.modal("show")},e.confirm_yes=function(){var t=$(".hla-widget-add-table");n.delete({id:e.deleteId},function(a){e.message=a,"200"==e.message.status&&(e.reload(),t.slideUp())}),o.modal("hide")},o.find(".op_yes").off().click(function(){e.confirm_yes()}),e.reload=function(){e.list=n.get(e.page,function(t){t.result=t.result.map(function(t){return e.page.count=e.list.totalCount,t})})},e.addHostPort=function(){var t=e.datasource.data.hostPorts;t||(t=e.datasource.data.hostPorts=[]),t.push(["",""])},e.removeHostPort=function(t){e.datasource.data.hostPorts.splice(t,1)},e.addHostEncoding=function(){var t=e.datasource.data.listens;t||(t=e.datasource.data.listens=[]),t.push(["",""])},e.removeHostEncoding=function(t){e.datasource.data.listens.splice(t,1)},e.changeDBType=function(){var t=e.datasource.data.protocol,a=null;switch(e.drivers=[],t){case"mysql":a=3306,e.datasource.data.driver="com.mysql.jdbc.Driver";break;case"oracle":a=1521,e.datasource.data.driver="oracle.jdbc.driver.OracleDriver";break;case"sqlserver":a=1433,e.datasource.data.driver="com.microsoft.jdbc.sqlserver.SQLServerDriver";break;case"DB2":e.datasource.data.driver="com.ibm.db2.jcc.DB2Driver",a=5e4;break;case"sybase":a=5e3,e.datasource.data.driver="net.sourceforge.jtds.jdbc.Driver";break;case"postgresql":e.datasource.data.driver="org.postgresql.Driver",a=5432;break;case"sqlite":e.datasource.data.driver="org.sqlite.JDBC",a=0;break;case"derby":e.datasource.data.driver="org.apache.derby.jdbc.EmbeddedDriver",a=1527;break;case"phoenix":e.datasource.data.driver="org.apache.phoenix.jdbc.PhoenixDriver",a=2181}e.datasource.data.port=a},e.changeDataSourceName=function(){var t=e.datasource.data.name,a=angular.extend(angular.copy(l.data),{name:t});e.single="line","file"===t||("net"===t?(a.contentType="net",a.host="0.0.0.0",a.port=514):"ftp"===t||"hdfs"===t||"sftp"===t?("ftp"===t?a.port=21:"sftp"===t?a.port=22:"hdfs"===t&&(a.port=9e3,a.authentication="NONE"),a.path={},angular.extend(a.path,{contentType:a.contentType,name:"file",category:"other",position:a.position,skipLine:a.skipLine,codec:a.codec})):"es2"===t||"es5"===t?(a.index="logs_$",a.esType="logs",a.field="@timestamp",a.hostPorts=[]):"kafka"==t?a.wildcard="false":"tuple"==t?(a.on={name:"sql",first:{maxOutOfOrderness:1e4,fields:[]},second:{maxOutOfOrderness:1e4,fields:[]},timeCharacteristic:"ProcessingTime"},e.resolver={first:{},second:{}},e.timefields={first:[],second:[]}):"single-table"==t?(a.channel={},a.table={timeCharacteristic:"ProcessingTime",maxOutOfOrderness:1e4,fields:[]},e.resolver={channel:{}},e.timefields={channel:[]}):(a.data={},delete a.contentType,delete a.properties,delete a.position,delete a.skipLine,delete a.protocol,delete a.cache)),e.datasource.data=a},e.downloadFile=function(e){n.download({id:e},function(t){var a="数据源配置";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})},e.changeChannel=function(t){"channel"==t?(e.datasource.data.table.resolverId=e.channels.filter(function(a){return a.id===e.datasource.data[t].ref}).shift().parser,e.resolver[t]=e.parsers.filter(function(t){return t.id===e.datasource.data.table.resolverId}).shift()):(e.datasource.data.on[t].resolverId=e.channels.filter(function(a){return a.id===e.datasource.data[t].ref}).shift().parser,e.resolver[t]=e.parsers.filter(function(a){return a.id===e.datasource.data.on[t].resolverId}).shift()),e.timefields[t]=e.resolver[t].properties.filter(function(e){return"datetime"===e.type||"long"===e.type})},e.changeFieldName=function(t,a){var r="";if(r="channel"==t?e.datasource.data.table.fromFields[a][0]:e.datasource.data.on[t].fromFields[a][0],e.resolver&&e.resolver[t]&&e.resolver[t].properties){var n=e.resolver[t].properties.filter(function(e){return e.key===r}).shift();n&&("channel"==t?e.datasource.data.table.fromFields[a][1]=n.type:e.datasource.data.on[t].fromFields[a][1]=n.type)}},e.addProperty=function(t){"channel"==t?e.datasource.data.table.fields?e.datasource.data.table.fields.push(["","string"]):(e.datasource.data.table.fields=[],e.datasource.data.table.fields.push(["","string"])):e.datasource.data.on[t].resolverId?e.datasource.data.on[t].fields?e.datasource.data.on[t].fields.push(["","string"]):(e.datasource.data.on[t].fields=[],e.datasource.data.on[t].fields.push(["","string"])):(e.confirm={title:"提示",message:"您未选择解析规则，确认添加字段么？",ok:function(){e.datasource.data.on[t].fields.push(["","string"]),$("#commonConfirmModal").modal("hide")},cancel:function(){$("#commonConfirmModal").modal("hide")}},$("#commonConfirmModal").modal("show"))},e.deleteProperty=function(t,a){"channel"==t?e.datasource.data.table.fields.splice(a,1):e.datasource.data.on[t].fields.splice(a,1)},e.changeTimeField=function(t){if(e.timefields[t]){var a="";a="channel"==t?e.timefields[t].filter(function(t){return t.key===e.datasource.data.table.timeField}).shift():e.timefields[t].filter(function(a){return a.key===e.datasource.data.on[t].timeField}).shift(),a||(e.message={status:"300",title:"警告！",message:"解析规则中不存在您填写的时间字段，请确认字段是否为时间类型或long类型"})}}}]),app.controller("CollectorController",["$scope","$rootScope","$location","$routeParams","Collector","CollectorOpt",function(e,t,a,r,n,s){var i=$("#collectModal");t.$path=a.path.bind(a),e.reload=function(){e.list=n.get(e.page)},e.delete=function(t,a){e.id=t,"UNAVAILABLE"===a?$("#collectModal .modal-body p").html("采集器不存在或者已经停止,删除有可能造成数据不一致,确认删除?"):$("#collectModal .modal-body p").html("确认要删除吗?"),i.modal("show")},e.operate=function(t,a){s.operate({id:a,opt:t},function(t){e.message=t,e.reload()})},e.confirm_yes=function(){n.delete({id:e.id},function(t){e.message=t,e.reload()}),i.modal("hide")},i.find(".op_yes").off().click(function(){e.confirm_yes()})}]),app.controller("DictionaryController",["$scope","$rootScope","$location","$routeParams","Dictionary","Util",function(e,t,a,r,n,s){t.$path=a.path.bind(a),e.reload=function(){e.list=n.get(e.page)},e.dictionary={name:"",key:"",properties:[]},e.add=function(){$(".hla-widget-add-table").slideToggle(),$(".hla-widget-search-table").slideUp(),e.dictionary={properties:[]},e.resetForm()},e.addProperty=function(t){e.dictionary.properties.push({key:"",value:"",vtype:"String"})},e.deleteProperty=function(t){delete e.dictionary.properties[t]},e.add_dictionary=function(t){n.save(e.dictionary,function(){e.reload()}),$(".hla-widget-add-table").slideUp()},e.search=function(){$(".hla-widget-add-table").slideUp(),$(".hla-widget-search-table").slideToggle(),e.dictionary={properties:[]}},e.searchDictionary=function(){e.page.search=e.searchDictionaryForm,e.reload()},e.edit=function(t){e.dictionary=n.get({id:t}),$(".hla-widget-add-table").slideDown(),$(".hla-widget-search-table").slideUp()},e.removeHostEncoding=function(t){e.dictionary.properties.splice(t,1)},e.delete=function(t){e.delete_id=t,$("#confirmModal").modal("show")},e.confirm_yes=function(){n.delete({id:e.delete_id},function(){e.reload()}),$("#confirmModal").modal("hide")},$("#confirmModal .op_yes").off().click(function(){e.confirm_yes()}),e.resetForm=function(t){e.addDicForm=angular.copy(t||{}),s.resetFormValidateState(e.add_dic_form)},e.resetForm()}]),app.controller("ParserController",["$scope","$rootScope","$location","Util","Parser","Knowledge","DataSource",function(e,t,a,r,n,s,i){function o(e,t){var a=/^([a-zA-Z]+)?(\d+)$/;if(a.test(e)&&a.test(t)){var r=a.exec(e),n=a.exec(t);return r[1]==n[1]?r[2]-n[2]:e-t}return e-t}function l(e){switch(e.name){case"addFields":case"mapping":e.fields=[["",""]];break;case"removeFields":e.fields=[""];break;case"addTags":case"removeTags":e.fields=[""];break;case"merger":e.fields=["",""];break;case"fieldCut":case"reParser":case"script":break;case"scriptFilter":case"redirect":case"startWith":case"endWith":case"match":case"contain":e.cases||(e.cases=[{name:"case",rule:{name:"addFields",fields:[["",""]]}}]);break;default:delete e.fields}}t.$path=a.path.bind(a),e.previewFields=[],e.datasources=i.query(),e.dsPreview=function(){i.preview({id:e.rule.datasource},function(t){e.datas=t,e.showPreview=!0,$("#log_property_list").show()})},e.all=n.query(),e.knowledges=s.query(),$("#addModal").modal("hide"),e.uploadFile=function(){delete e.message;var t=$(".hla-widget-add-table"),a=$(".hla-widget-search-table"),r=$(".hla-widget-upload-table"),s=$(".hla-widget-data-table"),i=e.myFile,o=new FileReader,l=[];e.all.length>0&&e.all.forEach(function(e){l.push(e.id)}),o.onloadend=function(i){var o=angular.fromJson(this.result);o.parser&&o.parser.filter&&o.parser.filter.length>0&&o.parser.filter.forEach(function(t){if(angular.equals(t.name,"byKnowledge")){0==e.knowledges.filter(function(e){return e.id==t.id}).length&&(t.id="")}t.cases&&t.cases.forEach(function(e,t){console.log(e),e.rule&&e.rule.ref&&-1===$.inArray(e.rule.ref,l)&&(e.rule.ref="")}),
t.default&&t.default.ref&&-1===$.inArray(t.default.ref,l)&&(t.default.ref="")}),e.rule=o,n.get({id:e.rule.id},function(n){if("404"===n.status)try{e.fromRule(),t.slideDown(),a.slideUp(),r.slideUp(),s.slideUp(),delete e.myFile}catch(t){e.message={status:"500",message:"数据解析出错,你检查你的数据文件是否是正确的解析规则内容!"}}else $("#addModal").modal("show")})};try{o.readAsText(i)}catch(t){e.message={status:"500",message:"数据解析出错,你检查你的数据文件是否正确!"}}},e.show=function(t,a){var s=$(".hla-widget-add-table"),i=$(".hla-widget-search-table"),o=$(".hla-widget-data-table"),l=$(".hla-widget-upload-table");switch(t){case"upload":delete e.message,e.searchDataSourceForm={},s.slideUp(),i.slideUp(),l.slideDown();break;case"add":delete e.message,e.rule={name:"",sample:"",parser:{name:"nothing"}},r.resetFormValidateState(e.add_form),s.slideToggle(),i.slideUp(),o.slideToggle(),l.slideUp();break;case"edit":delete e.message,n.get({id:a},function(t){console.log(t.datasource),e.rule=t,e.fromRule()}),r.resetFormValidateState(e.add_form),s.slideDown(),i.slideUp(),l.slideUp(),o.slideUp();break;case"copy":delete e.message,n.get({id:a},function(t){e.rule=t,delete e.rule.id,e.rule.name=e.rule.name+"_copy",e.fromRule()}),r.resetFormValidateState(e.add_form),s.slideDown(),i.slideUp(),l.slideUp(),o.slideUp();break;case"search":delete e.message,s.slideUp(),i.slideToggle(),l.slideUp(),o.slideDown(),e.page.search={};break;default:s.slideUp(),i.slideUp(),l.slideUp(),o.slideDown()}},e.reload=function(){e.list=n.get(e.page),e.all=n.query()},e.toRule=function(){var t=e.rule.parser.filter;if("delimit"==e.rule.parser.name&&(e.rule.parser.delimit=e.rule.parser.delimit.replace(/\\s/g," ").replace(/\\t/g,"\t").replace(/\\n/g,"\n"),e.rule.parser.fields&&e.rule.parser.fields.length>0)){var a=e.rule.parser.fields.split(",");delete e.rule.parser.fields,e.rule.parser.fields=a}if("delimitWithKeyMap"==e.rule.parser.name&&(e.rule.parser.delimit=e.rule.parser.delimit.replace(/\\s/g," ").replace(/\\t/g,"\t").replace(/\\n/g,"\n"),e.rule.parser.tab=e.rule.parser.tab.replace(/\\s/g," ").replace(/\\t/g,"\t").replace(/\\n/g,"\n")),t){for(var r=0;r<t.length;r++)switch(t[r].name){case"":delete t[r];break;case"merger":t[r].sep&&(t[r].sep=t[r].sep.replace(/\\s/g," ").replace(/\\t/g,"\t").replace(/\\n/g,"\n"));break;case"addFields":case"mapping":for(var n={},s=0;s<t[r].fields.length;s++)n[t[r].fields[s][0]]=t[r].fields[s][1];t[r].fields=n;break;case"redirect":case"startWith":case"endWith":case"match":case"scriptFilter":case"contain":if(t[r].cases){for(var i=t[r].cases,o=0;o<i.length;o++)switch(i[o].rule.name){case"":delete i[o];break;case"merger":i[o].rule.sep&&(i[o].rule.sep=i[o].rule.sep.replace(/\\s/g," ").replace(/\\t/g,"\t").replace(/\\n/g,"\n"));break;case"addFields":case"mapping":n={};for(var l=0;l<i[o].rule.fields.length;l++)n[i[o].rule.fields[l][0]]=i[o].rule.fields[l][1];i[o].rule.fields=n}t[r].cases=i}if(t[r].default)switch(t[r].default.name){case"":delete t[r].default;break;case"merger":cases[j].rule.sep&&(t[r].default.sep=t[r].default.sep.replace(/\\s/g," ").replace(/\\t/g,"\t").replace(/\\n/g,"\n"));break;case"addFields":case"mapping":n={};for(var c=0;c<t[r].default.fields.length;c++)n[t[r].default.fields[c][0]]=t[r].default.fields[c][1];t[r].default.fields=n}}e.rule.parser.filter=t}},e.fromRule=function(){var t=e.rule.parser.filter;if("delimit"==e.rule.parser.name){e.rule.parser.delimit=e.rule.parser.delimit.replace(/ /g,"\\s").replace(/\t/g,"\\t").replace(/\n/g,"\\n");var a=e.rule.parser.fields.reduce(function(e,t){return e+","+t});delete e.rule.parser.fields,e.rule.parser.fields=a}if("delimitWithKeyMap"==e.rule.parser.name&&(e.rule.parser.delimit=e.rule.parser.delimit.replace(/ /g,"\\s").replace(/\t/g,"\\t").replace(/\n/g,"\\n"),e.rule.parser.tab=e.rule.parser.tab.replace(/ /g,"\\s").replace(/\t/g,"\\t").replace(/\n/g,"\\n")),t)for(var r=0;r<t.length;r++)switch(t[r].name){case"merger":t[r].sep&&(t[r].sep=t[r].sep.replace(/ /g,"\\s").replace(/\t/g,"\\t").replace(/\n/g,"\\n"));break;case"addFields":case"mapping":var n=[];for(var s in t[r].fields)t[r].fields.hasOwnProperty(s)&&n.push([s,t[r].fields[s]]);t[r].fields=n;break;case"redirect":case"startWith":case"endWith":case"match":case"scriptFilter":case"contain":if(t[r].cases)for(var i=t[r].cases,o=0;o<i.length;o++)switch(i[o].rule.name){case"merger":i[o].rule.sep=i[o].rule.sep.replace(/ /g,"\\s").replace(/\t/g,"\\t").replace(/\n/g,"\\n");break;case"addFields":case"mapping":n=[];for(var l in i[o].rule.fields)i[o].rule.fields.hasOwnProperty(l)&&n.push([l,i[o].rule.fields[l]]);i[o].rule.fields=n}if(t[r].default)switch(t[r].default.name){case"merger":cases[j].rule.sep=cases[j].rule.sep.replace(/ /g,"\\s").replace(/\t/g,"\\t").replace(/\n/g,"\\n");break;case"addFields":case"mapping":n=[];for(var c in t[r].default.fields)t[r].default.fields.hasOwnProperty(c)&&n.push([c,t[r].default.fields[c]]);t[r].default.fields=n}}},e.saveRule=function(t){if(!t.$valid||e.rule.parser.fields&&!(e.rule.parser.fields.length>0))return!1;e.toRule(),e.rule.properties||(e.rule.properties=[]);for(var a=0;a<e.rule.properties.length;a++)e.rule.properties[a].hasOwnProperty("key")&&"list"==e.rule.properties[a].type&&(e.rule.properties[a].type="list["+e.rule.properties[a].subtype+"]",delete e.rule.properties[a].subtype);n.save(e.rule,function(t){console.log(t),e.message=t,"200"==e.message.status&&(e.reload(),e.show())})},e.saveOrEdit=function(t){var a=$(".hla-widget-add-table"),r=$(".hla-widget-search-table"),n=$(".hla-widget-upload-table"),s=$(".hla-widget-data-table");e.myFile,new FileReader;switch(t){case"edit":delete e.message;try{e.fromRule(),a.slideDown(),r.slideUp(),n.slideUp(),s.slideUp(),delete e.myFile,$("#addModal").modal("hide")}catch(t){e.message={status:"500",message:"数据解析出错,你检查你的数据文件是否是正确的解析规则内容!"}}break;case"save":delete e.message,delete e.rule.id,$("#addModal").modal("hide");try{e.fromRule(),a.slideDown(),r.slideUp(),n.slideUp(),s.slideUp(),delete e.myFile}catch(t){e.message={status:"500",message:"数据解析出错,你检查你的数据文件是否是正确的解析规则内容!"}}}},e.changeType=function(t){switch(e.rule.properties[t].type){case"list":break;default:delete e.rule.properties[t].subtype}},e.delete=function(t){e.delete_id=t,$("#confirmModal").modal("show")},e.confirm_yes=function(){n.delete({id:e.delete_id},function(t){e.message=t,$("#confirmModal").modal("hide"),e.reload()})},$("#confirmModal").find(".op_yes").off().click(function(){e.confirm_yes()}),e.initFields=function(t){if("delimit"!=e.rule.parser.name||e.rule.parser.fields&&0!=e.rule.parser.fields.length)if(e.rule.sample&&e.rule.sample.length>0){e.rule.sample.split("#next#");e.toRule(),n.preview(e.rule,function(a){for(var r=0;r<a.length;r++)for(var n in a[r].toJSON()){var s=$.inArray(n,e.previewFields);s<0&&e.previewFields.push(n)}e.fromRule(),t&&t()})}else e.rule.properties?e.rule.properties.forEach(function(t){e.previewFields.push(t.key);var a=t.type.match(/list\[(.*)]/);a&&a.length>=2&&(t.type="list",t.subtype=a[1])}):e.rule.properties=[],t&&t();else if(e.rule.parser.fields||(e.rule.parser.fields=[]),e.previewFields=[],0==e.rule.parser.fields.length)if(e.rule.sample&&e.rule.sample.length>0){e.rule.sample.split("#next#");e.toRule(),n.preview(e.rule,function(a){for(var r=0;r<a.length;r++)for(var n in a[r].toJSON()){var s=$.inArray(n,e.rule.parser.fields);s<0&&(e.rule.parser.fields.push(n),e.previewFields.push(n))}e.rule.parser.fields=e.rule.parser.fields.sort(o),e.fromRule(),t&&t()})}else t&&t()},e.addDelimitField=function(){e.initFields()},e.removeDelimitField=function(t){e.rule.parser.fields.splice(t,1)},e.removeFilter=function(t){e.rule.parser.filter.splice(t,1)},e.addFilter=function(){e.initFields(function(){e.rule.parser.filter||(e.rule.parser.filter=[]),e.rule.parser.filter.push({name:"addFields",fields:[["",""]]})})},e.ruleChange=function(t){l(e.rule.parser.filter[t])},e.caseDefaultChange=function(t){l(e.rule.parser.filter[t].default)},e.addFilterTuple=function(t){var a=e.rule.parser.filter[t].fields;a||(e.rule.parser.filter[t].fields=a=[]),a.push(["",""])},e.removeFilterTuple=function(t,a){e.rule.parser.filter[t].fields.splice(a,1)},e.addFilterOne=function(t){e.rule.parser.filter[t].fields||(e.rule.parser.filter[t].fields=[]),e.rule.parser.filter[t].fields.push("")},e.removeFilterOne=function(t,a){e.rule.parser.filter[t].fields.splice(a,1)},e.addFilterDefaultTuple=function(t){var a=e.rule.parser.filter[t].default.fields;a||(e.rule.parser.filter[t].default.fields=a=[]),a.push(["",""])},e.removeFilterDefaultTuple=function(t,a){e.rule.parser.filter[t].default.fields.splice(a,1)},e.addFilterDefaultOne=function(t){e.rule.parser.filter[t].default.fields||(e.rule.parser.filter[t].default.fields=[]),e.rule.parser.filter[t].default.fields.push("")},e.removeFilterDefaultOne=function(t,a){e.rule.parser.filter[t].default.fields.splice(a,1)},e.addCase=function(t){e.rule.parser.filter[t].cases||(e.rule.parser.filter[t].cases=[]),e.rule.parser.filter[t].cases.push({name:"case",rule:{name:"addFields",fields:[["",""]]}})},e.removeCase=function(t,a){e.rule.parser.filter[t].cases.splice(a,1)},e.caseChange=function(t,a){l(e.rule.parser.filter[t].cases[a].rule)},e.addCaseTuple=function(t,a){var r=e.rule.parser.filter[t].cases[a].rule.fields;r&&angular.isArray(r)||(e.rule.parser.filter[t].cases[a].rule.fields=r=[]),r.push(["",""])},e.removeCaseTuple=function(t,a,r){e.rule.parser.filter[t].cases[a].rule.fields.splice(r,1)},e.addCaseOne=function(t,a){e.rule.parser.filter[t].cases[a].rule.fields||(e.rule.parser.filter[t].cases[a].rule.fields=[]),e.rule.parser.filter[t].cases[a].rule.fields.push("")},e.removeCaseOne=function(t,a,r){e.rule.parser.filter[t].cases[a].rule.fields.splice(r,1)},e.resetPreview=function(){e.rule.properties=[]},e.preview=function(t){if(t.$submitted||(t.$submitted=!0),!t.$valid||e.rule.parser.fields&&!(e.rule.parser.fields.length>0))return!1;e.toRule(),n.properties(e.rule,function(t){if(t){var a=t[0];console.log(a),e.rule.properties=[];for(var r in a)a[r].hasOwnProperty("key")&&e.rule.properties.push(a[r]);for(var n=0;n<e.rule.properties.length;n++)if(e.rule.properties[n].hasOwnProperty("key")){var s=e.rule.properties[n].type.match(/list\[(.*)]/);s&&s.length>=2&&(e.rule.properties[n].type="list",e.rule.properties[n].subtype=s[1])}e.datas=t[1]}else console.log(t);e.fromRule(),$("#log_property_list").show()})},e.addProperty=function(){e.rule.properties.push({key:"",name:"",type:"object",sample:""})},e.deleteProperty=function(t){e.rule.properties.splice(t,1)},e.properties_index_refresh=function(e){for(var t=$("#properties").children("div").length,a=e+1;a<=t;a++)!function(e){$.each($("#properties").find("input[name^='properties["+e+"]'],select[name^='properties["+e+"]']"),function(t,a){0==t&&$(a).closest(".op_event_relate").attr("property_index",e-1),$(a).attr("name",a.name.replace(e,e-1))})}(a)},e.log_property_list_clean=function(){$("#properties").children().remove(),$("#log_property_list").hide()},e.downloadFile=function(e){n.download({id:e},function(t){var a="解析规则";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})}}]),app.controller("AnalyzerController",["$scope","$rootScope","$location","Modeling","DataSource","Analyzer","Util",function(e,t,a,r,n,s,i){e.aceLoaded=function(e){},e.aceValue="Foobar",e.aceChanged=function(e){},e.previewData={},e.channels=n.byType({type:"channel"}),e.analyzers=s.query(),e.modelings=r.queryByType({type:"model"}),e.addProperty=function(){e.rule.channel?(e.rule.data.fromFields||(e.rule.data.fromFields=[]),e.rule.data.fromFields.push(["","string"])):(e.confirm={title:"提示",message:"您未选择解析规则，确认添加字段么？",ok:function(){e.rule.data.fromFields.push(["","string"]),$("#commonConfirmModal").modal("hide")},cancel:function(){$("#commonConfirmModal").modal("hide")}},$("#commonConfirmModal").modal("show"))},e.deleteProperty=function(t){e.rule.data.fromFields.splice(t,1)},e.addHashField=function(){e.rule.data.cols||(e.rule.data.cols=[]),e.rule.data.cols.push(["","null","","null"])},e.deleteHashField=function(t){e.rule.data.cols.splice(t,1)},e.channelChange=function(){e.resolver=e.channels.filter(function(t){return t.id===e.rule.channel}).shift(),e.timefields=e.resolver.properties.filter(function(e){return"datetime"===e.type||"long"===e.type})},e.changeFieldName=function(t){var a=e.rule.data.fromFields[t][0];if(e.resolver&&e.resolver.properties){var r=e.resolver.properties.filter(function(e){return e.key===a}).shift();r&&(e.rule.data.fromFields[t][1]=r.type)}},e.changeVecFiledName=function(t){var a=e.rule.data.cols[t][0];if(e.resolver&&e.resolver.properties){var r=e.resolver.properties.filter(function(e){return e.key===a}).shift();r&&("string"==r.type?e.rule.data.cols[t][1]="simhash":"integer"==r.type||"long"==r.type||"float"==r.type||"double"==r.type?e.rule.data.cols[t][1]="null":e.confirm={title:"错误",message:"字段["+a+"]类型为["+r.type+"],不可参与向量化",ok:function(){e.rule.data.cols[t][0]=""}})}},e.addFilter=function(){e.rule.data.filter||(e.rule.data.filter=[]),e.rule.data.filter.push({name:"streamRedirect",cases:[]}),e.addCase(e.rule.data.filter.length-1)},e.removeFilter=function(t){e.rule.data.filter.splice(t,1)},e.addCase=function(t){e.rule.data.filter[t].cases||(e.rule.data.filter[t].cases=[]),e.rule.data.filter[t].cases.push({name:"streamCase",rule:{name:"streamAnalyzer"}})},e.removeCase=function(t,a){e.rule.data.filter[t].cases.splice(a,1)},e.caseChange=function(t,a){delete e.rule.data.filter[t].cases[a].rule.ref},e.validateForm=function(e){return!!e&&(!!e.$valid&&(e.$submitted||(e.$submitted=!0),!0))},e.saveRule=function(t){e.validateForm(t)&&s.save(e.rule,function(t){e.message=t,"200"==e.message.status&&(e.reload(),e.show(),$(".hla-widget-add-table").slideUp(),e.reload())})},e.showPreview=!1,e.preview=function(t){delete e.message,e.validateForm(t)&&s.preview(e.rule,function(t){t.status&&500==t.status?e.message={status:"500",title:"错误！",message:t.message}:(e.previewData=t,e.showPreview=!0)})},e.reload=function(){e.list={},e.list=s.get(e.page)},e.show=function(t,a){var r=$(".hla-widget-add-table"),n=$(".hla-widget-search-table"),o=$(".hla-widget-data-table"),l=$(".hla-widget-upload-table");switch(t){case"upload":delete e.message,e.searchDataSourceForm={},r.slideUp(),n.slideUp(),l.slideDown();break;case"add":delete e.message,e.rule={name:"",data:{name:"sql",timeSeriesModel:{modelType:"ADDITIVE"},timeCharacteristic:"ProcessingTime",maxOutOfOrderness:1e4,fromFields:[]}},i.resetFormValidateState(e.add_form),r.slideToggle(),n.slideUp(),o.slideToggle(),l.slideUp();break;case"edit":delete e.message,s.get({id:a},function(t){t.data&&t.channel&&(e.resolver=e.channels.filter(function(e){return e.id===t.channel}).shift(),e.resolver&&e.resolver.properties&&(e.timefields=e.resolver.properties.filter(function(e){return"datetime"===e.type||"long"===e.type}))),e.rule=t}),i.resetFormValidateState(e.add_form),r.slideDown(),n.slideUp(),l.slideUp(),o.slideUp();break;case"copy":delete e.message,s.get({id:a},function(t){e.rule=t,delete e.rule.id,e.rule.name=e.rule.name+"_copy",e.resolver=e.channels.filter(function(t){return t.id===e.rule.channel}).shift(),e.resolver&&(e.timefields=e.resolver.properties.filter(function(e){return"datetime"===e.type||"long"===e.type}))}),i.resetFormValidateState(e.add_form),r.slideDown(),n.slideUp(),l.slideUp(),o.slideUp();break;case"search":delete e.message,r.slideUp(),n.slideToggle(),l.slideUp(),o.slideDown(),e.page.search={},e.page.search.name=null;break;default:r.slideUp(),n.slideUp(),l.slideUp(),o.slideDown()}},e.downloadFile=function(e){s.download({id:e},function(t){var a="streamSql分析规则";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})},e.uploadFile=function(){delete e.message;var t=$(".hla-widget-add-table"),a=$(".hla-widget-search-table"),r=$(".hla-widget-upload-table"),n=$(".hla-widget-data-table"),s=e.myFile,i=new FileReader;i.onloadend=function(s){e.rule=angular.fromJson(this.result);try{t.slideDown(),a.slideUp(),r.slideUp(),n.slideUp(),delete e.myFile,e.$apply()}catch(s){e.message={status:"500",title:"错误！",message:"数据解析出错,你检查你的数据文件是否是正确的解析规则内容!"}}};try{i.readAsText(s)}catch(t){e.message={status:"500",title:"错误！",message:"数据解析出错,你检查你的数据文件是否正确!"}}},e.validateSql=function(){var t=e.rule.data.sql;if(t)return t=t.toUpperCase(),-1!=t.indexOf("SELECT")&&-1!=t.indexOf("FROM")||(e.message={status:"500",title:"错误！",message:"SQL语句不合法，请填写正确的SQL"},!1)},e.delete=function(t){e.delete_id=t,$("#confirmModal").modal("show")},e.confirm_yes=function(){s.delete({id:e.delete_id},function(t){e.message=t,$("#confirmModal").modal("hide"),e.reload()})},$("#confirmModal").find(".op_yes").off().click(function(){e.confirm_yes()}),e.typeChange=function(){console.log(e.rule.type+"===================="+e.type),r.queryByType({type:e.rule.type},function(t){e.modelings=t})}}]),app.controller("WriterController",["$scope","$rootScope","$location","Util","Writer","Collector",function(e,t,a,r,n,s){t.$path=a.path.bind(a),e.encodings=["UTF-8","GBK","GB18030","GB2312","BIG5","UNICODE","ASCII","ISO-8859-1"];var i=$("#confirmModal"),o={data:{name:"es5",number_of_shards:5,number_of_replicas:0,cache:1e3,date_detection:!0,persisRef:{name:"none"},protocol:{name:"udp"},contentType:{name:"json",contentType:{name:"json"}},authentication:"NONE",properties:{connectTimeout:"300"}}};e.collectors=s.query(),e.writers=n.query(),e.resetForm=function(){e.writer=angular.copy(o),r.resetFormValidateState(e.ds_form)},e.resetForm(),e.changeName=function(){switch(e.writer.data.name){case"hdfs":e.writer.data.authentication="NONE";case"ftp":case"sftp":e.writer.data.path=angular.copy({name:"file",persisRef:{name:"none"},contentType:{name:"json",contentType:{name:"json"}}});break;default:delete e.writer.data.path}},e.contentTypeChange=function(){switch(e.writer.data.contentType.name){case"syslog":e.writer.data.contentType.contentType=angular.copy({name:"json"}),e.writer.data.contentType.syslogFormat=angular.copy({facility:"0",level:"0",priorityType:"DATA",timestampType:"DATA"})}},e.pathContentTypeChange=function(){switch(e.writer.data.path.contentType.name){case"syslog":e.writer.data.path.contentType.contentType=angular.copy({name:"json"}),e.writer.data.path.contentType.syslogFormat=angular.copy({facility:"0",level:"0",priorityType:"DATA"})}},e.timestampTypeChange=function(){switch(e.writer.data.contentType.syslogFormat.timestampType){case"VAL":e.writer.data.contentType.syslogFormat.timestamp=new Date;break;default:delete e.writer.data.contentType.syslogFormat.timestamp}},e.pathTimestampTypeChange=function(){switch(e.writer.data.path.contentType.syslogFormat.timestampType){case"VAL":e.writer.data.path.contentType.syslogFormat.timestamp=new Date;break;default:delete e.writer.data.path.contentType.syslogFormat.timestamp}},e.saveWriter=function(t){if(!t)return!1;var a=e.writer;n.save(a,function(t){e.message=t,"200"==e.message.status&&(e.reload(),$(".hla-widget-add-table").slideUp())})},e.changeDBType=function(){var t=e.writer.data.protocol,a=null;switch(t){case"mysql":a=3306,e.writer.data.driver="com.mysql.jdbc.Driver";break;case"oracle":a=1521,e.writer.data.driver="oracle.jdbc.driver.OracleDriver";break;case"sqlserver":a=1433,e.writer.data.driver="com.microsoft.jdbc.sqlserver.SQLServerDriver";break;case"DB2":e.writer.data.driver="com.ibm.db2.jcc.DB2Driver",a=5e4;break;case"sybase":a=5e3,e.writer.data.driver="net.sourceforge.jtds.jdbc.Driver";break;case"postgresql":e.writer.data.driver="org.postgresql.Driver",a=5432;break;case"sqlite":e.writer.data.driver="org.sqlite.JDBC",a=0;break;case"derby":e.writer.data.driver="org.apache.derby.jdbc.EmbeddedDriver",a=1527;break;case"phoenix":e.writer.data.driver="org.apache.phoenix.jdbc.PhoenixDriver",a=2181}e.writer.data.port=a},e.uploadFile=function(){var t=$(".hla-widget-add-table"),a=$(".hla-widget-search-table"),r=$(".hla-widget-upload-table"),n=e.myFile,s=new FileReader;s.onload=function(n){e.writer=angular.fromJson(this.result),"forward"==e.writer.writeType&&e.collectorChange(),t.slideDown(),a.slideUp(),r.slideUp(),e.$apply()},s.readAsText(n)},e.show=function(t,a){delete e.message;var s=$(".hla-widget-add-table"),i=$(".hla-widget-search-table"),o=$(".hla-widget-upload-table");switch(r.resetFormValidateState(e.ds_form),t){case"upload":e.searchDataSourceForm={},s.slideUp(),i.slideUp(),o.slideDown();break;case"search":e.searchDataSourceForm={},s.slideUp(),i.slideToggle(),o.slideUp();break;case"add":s.slideToggle(),i.slideUp(),o.slideUp(),e.resetForm();break;case"edit":n.get({id:a},function(t){e.writer=t,"forward"==e.writer.writeType&&e.collectorChange()}),s.slideDown(),i.slideUp(),o.slideUp();break;case"copy":n.get({id:a},function(t){e.writer=t,e.writer.name=e.writer.name+"_copy",delete e.writer.id,"forward"==e.writer.writeType&&e.collectorChange()}),s.slideDown(),i.slideUp(),o.slideUp();break;default:s.slideUp(),i.slideUp(),o.slideUp()}},e.delete=function(t){e.deleteId=t,i.modal("show")},e.confirm_yes=function(){n.delete({id:e.deleteId},function(t){e.message=t,e.reload()}),i.modal("hide")},i.find(".op_yes").off().click(function(){e.confirm_yes()}),e.reload=function(){e.list=n.get(e.page)},e.addZkAddress=function(){var t=e.writer.data.zookeeperConnect;t||(t=e.writer.data.zookeeperConnect=[]),t.push(["",2181])},e.removeZkAddress=function(t){e.writer.data.zookeeperConnect.splice(t,1)},e.addKafAddress=function(){var t=e.writer.data.metadataBrokerList;t||(t=e.writer.data.metadataBrokerList=[]),t.push(["",9092])},e.removeKafAddress=function(t){e.writer.data.metadataBrokerList.splice(t,1)},e.addHostPort=function(){var t=e.writer.data.hostPorts;t||(t=e.writer.data.hostPorts=[]),t.push(["",9300])},e.removeHostPort=function(t){e.writer.data.hostPorts.splice(t,1)},e.addWriter=function(){var t=e.writer.data.writers;t||(t=e.writer.data.writers=[]),t.push(["",""])},e.removeWriter=function(t){e.writer.data.writers.splice(t,1)},e.collectorChange=function(){var t=e.writer.data;if(t.id){var a=null;e.collectors.$resolved&&angular.forEach(e.collectors,function(e,r){if(e.id==t.id)return a=e,!0}),a&&(t.host=a.host,t.port=a.port)}},e.caseWriterChange=function(t){var a=e.writer.data.writers[t][1].id;if(a){var r=null;e.writers.$resolved&&angular.forEach(e.writers,function(e,t){if(e.id==a)return r=e.data,!0}),r&&(e.writer.data.writers[t][1]=r,e.writer.data.writers[t][1].id=a)}},e.defaultWriterChange=function(){var t=e.writer.data.default.id;if(t){var a=null;e.writers.$resolved&&angular.forEach(e.writers,function(e,r){if(e.id==t)return a=e.data,!0}),a&&(e.writer.data.default=a,e.writer.data.default.id=t)}},e.downloadFile=function(e){n.download({id:e},function(t){var a="存储配置";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})}}]),app.controller("TimerController",["$scope","$rootScope","$location","Util","Timer","Channel","Modeling","Knowledge","Collector","DataSource",function(e,t,a,r,n,s,i,o,l,c){t.$path=a.path.bind(a),e.datasources=c.query(),e.channels=s.query(),e.modelings=i.query(),e.knowledges=o.query(),e.list=e.channels,e.index=1;var d=$("#confirmModal"),p={timer:{isDepend:!1,jobType:"CHANNEL",action:"START"}};e.collectors=l.query(),e.timers=n.query(),e.resetForm=function(){e.timer=angular.copy(p),r.resetFormValidateState(e.ds_form)},e.resetForm(),e.saveTimer=function(t){if(!t)return!1;var a=e.timer;n.save(a,function(t){e.message=t,"200"===e.message.status&&(e.reload(),$(".hla-widget-add-table").slideUp())})},e.addFilterTuple=function(e){console.log(e)},e.uploadFile=function(){var t=$(".hla-widget-add-table"),a=$(".hla-widget-search-table"),r=$(".hla-widget-upload-table"),n=e.myFile,s=new FileReader;s.onload=function(){e.timer=angular.fromJson(this.result),t.slideDown(),a.slideUp(),r.slideUp(),e.$apply()},s.readAsText(n)},e.show=function(t,a){delete e.message;var s=$(".hla-widget-add-table"),i=$(".hla-widget-search-table"),o=$(".hla-widget-upload-table");switch(r.resetFormValidateState(e.ds_form),t){case"upload":e.searchDataSourceForm={},s.slideUp(),i.slideUp(),o.slideDown();break;case"search":e.searchDataSourceForm={},s.slideUp(),i.slideToggle(),o.slideUp();break;case"add":s.slideToggle(),i.slideUp(),o.slideUp(),e.resetForm();break;case"edit":n.get({id:a},function(t){console.log(t),e.timer=t}),s.slideDown(),i.slideUp(),o.slideUp();break;case"copy":n.get({id:a},function(t){e.timer=t,e.timer.name=e.timer.name+"_copy",delete e.timer.id}),s.slideDown(),i.slideUp(),o.slideUp();break;default:s.slideUp(),i.slideUp(),o.slideUp()}},e.delete=function(t){e.deleteId=t,d.modal("show")},e.confirm_yes=function(){n.delete({id:e.deleteId},function(t){e.message=t,e.reload()}),d.modal("hide")},d.find(".op_yes").off().click(function(){e.confirm_yes()});var u=$("#pauseConfirmModal");e.pause=function(t){e.pauseId=t,u.modal("show")},e.pauseConfirm_yes=function(){n.delete({id:e.deleteId},function(t){e.message=t,e.reload()}),u.modal("hide")},u.find(".op_yes").off().click(function(){e.pauseConfirm_yes()}),e.reload=function(){e.list=n.get(e.page)},e.downloadFile=function(e){n.download({id:e},function(t){var a="定时器下载";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.timer])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})}}]),app.controller("TimerDependsController",["$scope","$rootScope","$location","Util","TimerDepends","Channel","Modeling","Knowledge","Collector","DataSource",function(e,t,a,r,n,s,i,o,l,c){t.$path=a.path.bind(a),e.datasources=c.query(),e.channels=s.query(),e.modelings=i.query(),e.knowledges=o.query(),e.dependsString='[{"jobId": "name0"},{"jobId": "name1","parentId": "name0"}]',console.log(e.channels),console.log(e.modelings),console.log(e.knowledges);var d=$("#confirmModal"),p={timer:{enable:!1,repeat:!1,name:"single",first:function(e){var t=e.getFullYear(),a=e.getMonth()+1;a=a<10?"0"+a:a;var r=e.getDate();r=r<10?"0"+r:r;var n=e.getHours()+1;n=n<10?"0"+n:n;var s=e.getMinutes(),i=e.getSeconds();return s=s<10?"0"+s:s,i=i<10?"0"+i:i,t+"-"+a+"-"+r+" "+n+":"+s+":"+i}(new Date),end:function(e){var t=e.getFullYear(),a=e.getMonth()+1;a=a<10?"0"+a:a;var r=e.getDate();r=r<10?"0"+r:r;var n=e.getHours()+2;n=n<10?"0"+n:n;var s=e.getMinutes(),i=e.getSeconds();return s=s<10?"0"+s:s,i=i<10?"0"+i:i,t+"-"+a+"-"+r+" "+n+":"+s+":"+i}(new Date),action:"START"}};e.collectors=l.query(),e.resetForm=function(){e.timerDepends=angular.copy(p),r.resetFormValidateState(e.ds_form)},e.resetForm(),e.saveTimer=function(t){if(!t)return!1;console.log(angular.fromJson(e.dependsString)),e.timerDepends.depends=angular.fromJson(e.dependsString);var a=e.timerDepends;n.save(a,function(t){e.message=t,"200"===e.message.status&&(e.reload(),$(".hla-widget-add-table").slideUp())})},e.uploadFile=function(){var t=$(".hla-widget-add-table"),a=$(".hla-widget-search-table"),r=$(".hla-widget-upload-table"),n=e.myFile,s=new FileReader;s.onload=function(){e.timerDepends=angular.fromJson(this.result),t.slideDown(),a.slideUp(),r.slideUp(),e.$apply()},s.readAsText(n)},e.show=function(t,a){delete e.message;var s=$(".hla-widget-add-table"),i=$(".hla-widget-search-table"),o=$(".hla-widget-upload-table");switch(r.resetFormValidateState(e.ds_form),t){case"upload":e.searchDataSourceForm={},s.slideUp(),i.slideUp(),o.slideDown();break;case"search":e.searchDataSourceForm={},s.slideUp(),i.slideToggle(),o.slideUp();break;case"add":s.slideToggle(),i.slideUp(),o.slideUp(),e.resetForm();break;case"edit":n.get({id:a},function(t){console.log(t),e.timerDepends=t}),s.slideDown(),i.slideUp(),o.slideUp();break;case"copy":n.get({id:a},function(t){e.timerDepends=t,e.timerDepends.name=e.timer.name+"_copy",delete e.timerDepends.id}),s.slideDown(),i.slideUp(),o.slideUp();break;default:s.slideUp(),i.slideUp(),o.slideUp()}},e.delete=function(t){e.deleteId=t,d.modal("show")},e.confirm_yes=function(){n.delete({id:e.deleteId},function(t){e.message=t,e.reload()}),d.modal("hide")},d.find(".op_yes").off().click(function(){e.confirm_yes()});var u=$("#pauseConfirmModal");e.pause=function(t){e.pauseId=t,u.modal("show")},e.pauseConfirm_yes=function(){n.delete({id:e.deleteId},function(t){e.message=t,e.reload()}),u.modal("hide")},u.find(".op_yes").off().click(function(){e.pauseConfirm_yes()}),e.reload=function(){e.list=n.get(e.page),console.log(e.list)},e.downloadFile=function(e){n.download({id:e},function(t){var a="定时器下载";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})}}]),app.controller("MetricsController",["$scope","Metrics","DataSource",function(e,t,a){e.options={chart:{type:"lineChart",height:450,margin:{top:20,right:20,bottom:40,left:55},x:function(e){return d3.time.format("%Y-%m-%d %H:%M:%S.%L").parse(e.x)},y:function(e){return e.y},useInteractiveGuideline:!0,dispatch:{stateChange:function(e){console.log("stateChange")},changeState:function(e){console.log("changeState")},tooltipShow:function(e){console.log("tooltipShow")},tooltipHide:function(e){console.log("tooltipHide")}},xAxis:{axisLabel:"时间(ms)",tickFormat:function(e){return d3.time.format("%H:%M:%S")(new Date(e))}},yAxis:{axisLabel:"条数/秒",tickFormat:function(e){return e},axisLabelDistance:-10},callback:function(e){console.log("!!! lineChart callback !!!")}},title:{enable:!0,text:"采集进度"},subtitle:{enable:!0,text:"显示每一个采集器,不同数据源的数据收集情况",css:{"text-align":"center",margin:"10px 13px 0px 7px"}},caption:{html:"<b>1.</b> X轴标示采集的数据条数, <span style='text-decoration: underline;'>EPS</span>,<i>Cum in purto erat, mea ne nominavi persecuti reformidans.</i> Docendi blandit abhorreant ea has, minim tantas alterum pro eu. <span style='color: darkred;'>Exerci graeci ad vix, elit tacimates ea duo</span>. Id mel eruditi fuisset. Stet vidit patrioque in pro, eum ex veri verterem abhorreant, id unum oportere intellegam nec<sup>[1, <a href='https://github.com/krispo/angular-nvd3' target='_blank'>2</a>, 3]</sup>.",enable:!0,css:{"text-align":"justify",margin:"10px 13px 0px 7px"}}},setInterval(function(){e.data=[],a.get({},function(a){var r=new Date,n=d3.time.format("%Y-%m-%d %H:%M:%S.%L")(r),s=d3.time.format("%Y-%m-%d %H:%M:%S.%L")(new Date(r.getTime()-432e5));console.log(s),console.log(n),a.result.forEach(function(a){t.query({collector:a.collectorId,id:a.id,from:s,to:n},function(t){var r=[];t.status||(t.forEach(function(e){if("METERS"===e.metricType){var t={x:e.datetime,y:Number(e.metric["mean rate"].split(" ")[0])};r.push(t)}}),r.length>0&&e.data.push({key:a.name,values:r}))})})})},1e4)}]),app.controller("ModelingController",["$scope","$rootScope","$location","Modeling","Analyzer","Util","DataSource","Metrics","Collector","Parser","Writer","Channel",function($scope,$rootScope,$location,Modeling,Analyzer,Util,DataSource,Metrics,Collector,Parser,Writer,Channel){function setWriterForViewer(e){if($scope.sinks.$resolved){var t=new Array($scope.sinks.length);if(e)for(var a=0,r=e.length;a<r;a++){var n=e[a];if(n){var s=function(e){for(var t=[],a=0,r=$scope.sinks.length;a<r;a++)if($scope.sinks[a].id==e){t=[a,$scope.sinks[a]];break}return t}(n);2==s.length&&(t[s[0]]={id:s[1].id,name:s[1].name})}}$scope.modeling.sinks=t}}function setForSave(e){return(e||[]).filter(function(e){return null!=e&&void 0!=e}).map(function(e){return e.id})}function propertiesWithType(){var reg=/^(true)|(false)|\d+$/;for(var item in $scope.modeling.properties){var v=$scope.modeling.properties[item];v&&reg.test(v)&&($scope.modeling.properties[item]=eval(v))}}$rootScope.$path=$location.path.bind($location),$scope.encodings=["UTF-8","GBK","GB18030","GB2312","BIG5","UNICODE","ASCII","ISO-8859-1"];var $confirmModal=$("#confirmModal");$scope.countMessage="采集的总量：未知"
;var d3_format=d3.time.format("%Y-%m-%d %H:%M:%S"),days=36e5;$scope.collectors=Collector.query(),$scope.channels=DataSource.byType({type:"channel"}),$scope.resolvers=Parser.query(),$scope.resolverList=$scope.resolvers,$scope.analyzers=Analyzer.query(),$scope.datasource={},$scope.changeDataSourceType=function(e){DataSource.get({id:e},function(e){$scope.datasource=e})},$scope.sinks=Writer.query(),$scope.analyzeSel=function(){$scope.analyzers.find(function(e){return e.id===$scope.modeling.analyzer&&("sql"==e.data.name?($scope.modeling.type.type="analyzer",$scope.modeling.typeDisable=!0):$scope.modeling.typeDisable=!1,!0)})},$scope.usableCheck=function(){var e=angular.copy($scope.modeling);e.sinks=setForSave(e.sinks),Modeling.check(e,function(e){$scope.rt=e})},$scope.resetForm=function(){$scope.modeling={sinks:[],type:{name:"analyzer"}},Util.resetFormValidateState($scope.ds_form)},$scope.resetForm(),$scope.save=function(e){if(!e)return!1;var t=angular.copy($scope.modeling);t.sinks=setForSave(t.sinks),Modeling.save(t,function(e){$scope.message=e,"200"==$scope.message.status&&($scope.reload(),$scope.show(),$(".hla-widget-add-table").slideUp())})},$scope.uploadFile=function(){delete $scope.message;var e=$(".hla-widget-add-table"),t=$(".hla-widget-search-table"),a=$(".hla-widget-upload-table"),r=$scope.myFile,n=new FileReader;n.onload=function(r){return function(r){$scope.modeling=angular.fromJson(this.result),delete $scope.modeling.id,0==$scope.collectors.filter(function(e){return e.id==$scope.modeling.worker}).length&&delete $scope.modeling.worker,0==$scope.analyzers.filter(function(e){return e.id==$scope.modeling.analyzer}).length&&delete $scope.modeling.analyzer,delete $scope.modeling.status,delete $scope.modeling.datatime,setWriterForViewer(angular.copy($scope.modeling.sinks)),e.slideDown(),t.slideUp(),a.slideUp(),delete $scope.myFile,$scope.$apply()}}();try{n.readAsText(r)}catch(e){$scope.message={status:"500",message:"数据解析出错,你检查你的数据文件是否正确!"}}},$scope.show=function(e,t){var a=$(".hla-widget-add-table"),r=$(".hla-widget-search-table"),n=$(".hla-widget-upload-table"),s=$(".hla-widget-metric-table");switch(Util.resetFormValidateState($scope.ds_form),e){case"upload":delete $scope.message,a.slideUp(),r.slideUp(),s.slideUp(),n.slideToggle();break;case"search":delete $scope.message,a.slideUp(),r.slideToggle(),s.slideUp(),n.slideUp();break;case"add":delete $scope.message,a.slideToggle(),r.slideUp(),s.slideUp(),n.slideUp(),$scope.resetForm();break;case"metric":delete $scope.message,$scope.metrics(t),a.slideUp(),r.slideUp(),s.slideDown(),n.slideUp();break;case"edit":delete $scope.message,Modeling.get({id:t},function(e){$scope.modeling=e,setWriterForViewer(angular.copy(e.sinks)),$scope.analyzeSel(),propertiesWithType(),n.slideUp(),a.slideDown(),s.slideUp(),r.slideUp()});break;case"copy":delete $scope.message,Modeling.get({id:t},function(e){$scope.modeling=e,$scope.modeling.name=$scope.modeling.name+"_copy",delete $scope.modeling.id,delete $scope.modeling.jobId,delete $scope.modeling.status,delete $scope.modeling.datatime,setWriterForViewer(angular.copy(e.sinks)),propertiesWithType(),a.slideDown(),r.slideUp(),s.slideUp(),n.slideUp()});break;case"connectTest":r.slideUp(),s.slideUp(),n.slideUp();break;default:a.slideUp(),r.slideUp(),s.slideUp(),n.slideUp()}},$scope.connectTest=function(e){var t=$scope.modeling.worker,a=$scope.modeling.type.cluster;e&&(angular.element("#connect_test").html('<i class="fa fa-spinner fa-spin"></i>'),Modeling.connectTest({opt:"check",workerId:t,url:a},function(e){$scope.message=e,angular.element("#connect_test").html("测试连接")},function(e){var t={message:"Connect to server has timed out, please try again later."};$scope.message=t,angular.element("#connect_test").html("测试连接")}))},$scope.operate=function(e,t){Modeling.operate({opt:e,id:t},function(e){$scope.message=e,$scope.reload()},function(e){var t={message:"Connect to server has timed out, please try again later."};$scope.message=t})},$scope.delete=function(e){$scope.deleteId=e,$confirmModal.modal("show")},$scope.confirm_yes=function(){Modeling.delete({id:$scope.deleteId},function(e){$scope.message=e,$scope.reload()}),$confirmModal.modal("hide")},$confirmModal.find(".op_yes").off().click(function(){$scope.confirm_yes()}),$scope.reload=function(){$scope.list=Modeling.get($scope.page,function(e){e.result.length>0?e.result=e.result.map(function(e){return e}):e.result=[]})},$scope.addHostPort=function(){var e=$scope.modeling.data.hostPorts;e||(e=$scope.modeling.data.hostPorts=[]),e.push(["",9300])},$scope.removeHostPort=function(e){$scope.modeling.data.hostPorts.splice(e,1)},$scope.addHostEncoding=function(){var e=$scope.modeling.data.listens;e||(e=$scope.modeling.data.listens=[]),e.push(["",""])},$scope.removeHostEncoding=function(e){$scope.modeling.data.listens.splice(e,1)},$scope.downloadFile=function(e){Modeling.download({id:e},function(t){var a="数据建模配置";a=decodeURI(a);var r=URL.createObjectURL(new Blob([t.data])),n=document.createElement("a");document.body.appendChild(n),n.href=r,n.download=a+"-"+e+".json",n.target="_blank",n.click(),n.remove()},function(e){})},$scope.querySourceType=function(e,t){void 0!==e&&"string"==typeof e.valueOf()&&e.length>0?DataSource.get({id:e},function(e){$scope.modeling.sourceType=e.data.name,t()}):t()},$scope.changeDataSource=function(e){$scope.querySourceType(e,function(){})},$scope.typeChange=function(){Analyzer.queryByType({type:$scope.modeling.type.name},function(e){$scope.analyzers=e})}}]);