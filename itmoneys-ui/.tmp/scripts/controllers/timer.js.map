{"version":3,"sources":["controllers/timer.js"],"names":["app","controller","$scope","$rootScope","$location","Util","Timer","Channel","Modeling","Knowledge","Collector","DataSource","$path","path","bind","datasources","query","channels","modelings","knowledges","list","index","$confirmModal","$","TimerDefault","timer","isDepend","jobType","action","collectors","timers","resetForm","angular","copy","resetFormValidateState","ds_form","saveTimer","formValid","dataForm","save","rt","message","status","reload","slideUp","addFilterTuple","console","log","uploadFile","$edit_table","$search_table","upload_table","file","myFile","reader","FileReader","onload","fromJson","result","slideDown","$apply","readAsText","show","clazz","id","searchDataSourceForm","slideToggle","get","ds","name","delete","deleteId","modal","confirm_yes","find","off","click","$pauseConfirmModal","pause","pauseId","pauseConfirm_yes","page","downloadFile","itemId","download","response","fileName","decodeURI","url","URL","createObjectURL","Blob","a","document","createElement","body","appendChild","href","target","remove"],"mappings":"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","file":"timer.js","sourcesContent":["'use strict';\r\n\r\napp.controller('TimerController', function ($scope, $rootScope, $location, Util, Timer, Channel, Modeling, Knowledge, Collector, DataSource) {\r\n    $rootScope.$path = $location.path.bind($location);\r\n    $scope.datasources = DataSource.query();\r\n    $scope.channels = Channel.query();\r\n    $scope.modelings = Modeling.query();\r\n    $scope.knowledges = Knowledge.query();\r\n    $scope.list = $scope.channels;\r\n    // ALTER TABLE TIMER ADD EXE_STATE INT DEFAULT 0;\r\n    // ALTER TABLE TIMER ADD JOB_TYPE VARCHAR(20);\r\n    // ALTER TABLE TIMER ADD TIMER_ACTION VARCHAR(20);\r\n    // console.log($scope.channels);\r\n    // console.log($scope.modelings);\r\n    // console.log($scope.knowledges);\r\n\r\n    // const formatStartTime = function (date) {\r\n    //     let y = date.getFullYear();\r\n    //     let m = date.getMonth() + 1;\r\n    //     m = m < 10 ? ('0' + m) : m;\r\n    //     let d = date.getDate();\r\n    //     d = d < 10 ? ('0' + d) : d;\r\n    //     let h = date.getHours() + 1;\r\n    //     h = h < 10 ? ('0' + h) : h;\r\n    //     let minute = date.getMinutes();\r\n    //     let second = date.getSeconds();\r\n    //     minute = minute < 10 ? ('0' + minute) : minute;\r\n    //     second = second < 10 ? ('0' + second) : second;\r\n    //     return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;\r\n    // };\r\n\r\n    $scope.index = 1;\r\n\r\n    // const formatEndTime = function (date) {\r\n    //     let y = date.getFullYear();\r\n    //     let m = date.getMonth() + 1;\r\n    //     m = m < 10 ? ('0' + m) : m;\r\n    //     let d = date.getDate();\r\n    //     d = d < 10 ? ('0' + d) : d;\r\n    //     let h = date.getHours() + 2;\r\n    //     h = h < 10 ? ('0' + h) : h;\r\n    //     let minute = date.getMinutes();\r\n    //     let second = date.getSeconds();\r\n    //     minute = minute < 10 ? ('0' + minute) : minute;\r\n    //     second = second < 10 ? ('0' + second) : second;\r\n    //     return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;\r\n    // };\r\n\r\n    const $confirmModal = $('#confirmModal');\r\n\r\n    const TimerDefault = {\r\n        timer: {\r\n            // enable: false,\r\n            isDepend: false,\r\n            jobType: 'CHANNEL',\r\n            // name: 'single',\r\n            // first: formatStartTime(new Date()),\r\n            // end: formatEndTime(new Date),\r\n            action: 'START'\r\n        }\r\n    };\r\n    //采集器\r\n    $scope.collectors = Collector.query();\r\n    $scope.timers = Timer.query();\r\n    //重置表单\r\n    $scope.resetForm = function () {\r\n        $scope.timer = angular.copy(TimerDefault);\r\n        Util.resetFormValidateState($scope.ds_form);\r\n    };\r\n    $scope.resetForm();\r\n\r\n    //保存\r\n    $scope.saveTimer = function (formValid) {\r\n        if (!formValid) return false;\r\n        // $scope.timer.timerType = $scope.timer.timer.name;\r\n        let dataForm = $scope.timer;\r\n        Timer.save(dataForm, function (rt) {\r\n            $scope.message = rt;\r\n            if ($scope.message.status === '200') {\r\n                $scope.reload();\r\n                $('.hla-widget-add-table').slideUp();\r\n            }\r\n        });\r\n    };\r\n\r\n\r\n    $scope.addFilterTuple = function (index) {\r\n        console.log(index);\r\n        // let fields = $scope.timer.timer.depends[index].dependsId;\r\n        // if (!fields) {\r\n        //     $scope.timer.timer.depends[index].dependsId = fields = []\r\n        // }\r\n        // fields.push(['', '']);\r\n    };\r\n\r\n\r\n\r\n    // $scope.addFilter = function () {\r\n    //\r\n    //     $scope.initFields(function () {\r\n    //         if (!$scope.rule.parser.filter) {\r\n    //             $scope.rule.parser.filter = []\r\n    //         }\r\n    //         $scope.rule.parser.filter.push({\r\n    //             name: 'addFields',\r\n    //             fields: [['', '']]\r\n    //         })\r\n    //     });\r\n    //\r\n    // };\r\n\r\n    // //\r\n    //\r\n    // $scope.switchCategory = function (id){\r\n    //     switch (id) {\r\n    //         case 'channel' : ;\r\n    //             $scope.list = $scope.channels;\r\n    //             $scope.list.\r\n    //             console.log(id);\r\n    //             console.log($scope.list);\r\n    //             break;\r\n    //         case 'knowledge' : ;\r\n    //             $scope.list = $scope.knowledges;\r\n    //             console.log(id);\r\n    //             console.log($scope.list);\r\n    //             break;\r\n    //         case 'modeling' : ;\r\n    //             $scope.list = $scope.modelings;\r\n    //             console.log(id);\r\n    //             console.log($scope.list);\r\n    //             break;\r\n    //         default :\r\n    //             $scope.list = $scope.channels;\r\n    //             console.log(id);\r\n    //             console.log($scope.list);\r\n    //             break;\r\n    //     }\r\n    // }\r\n\r\n\r\n\r\n\r\n\r\n    $scope.uploadFile = function () {\r\n        let $edit_table = $('.hla-widget-add-table');\r\n        let $search_table = $('.hla-widget-search-table');\r\n        let upload_table = $('.hla-widget-upload-table');\r\n        let file = $scope.myFile;\r\n        let reader = new FileReader();\r\n        reader.onload = function () {\r\n            $scope.timer = angular.fromJson(this.result);\r\n            $edit_table.slideDown();\r\n            $search_table.slideUp();\r\n            upload_table.slideUp();\r\n            $scope.$apply();\r\n        };\r\n        reader.readAsText(file);\r\n    };\r\n    $scope.show = function (clazz, id) {\r\n        delete  $scope.message;\r\n        let $edit_table = $('.hla-widget-add-table');\r\n        let $search_table = $('.hla-widget-search-table');\r\n        let upload_table = $('.hla-widget-upload-table');\r\n        Util.resetFormValidateState($scope.ds_form);\r\n        switch (clazz) {\r\n            case 'upload':\r\n                $scope.searchDataSourceForm = {};\r\n                $edit_table.slideUp();\r\n                $search_table.slideUp();\r\n                upload_table.slideDown();\r\n                break;\r\n            case 'search':\r\n                $scope.searchDataSourceForm = {};\r\n                $edit_table.slideUp();\r\n                $search_table.slideToggle();\r\n                upload_table.slideUp();\r\n                break;\r\n            case 'add':\r\n                $edit_table.slideToggle();\r\n                $search_table.slideUp();\r\n                upload_table.slideUp();\r\n                $scope.resetForm();\r\n                break;\r\n            case 'edit':\r\n                Timer.get({id: id}, function (ds) {\r\n                    console.log(ds);\r\n                    $scope.timer = ds;\r\n                });\r\n                $edit_table.slideDown();\r\n                $search_table.slideUp();\r\n                upload_table.slideUp();\r\n\r\n                break;\r\n            case 'copy':\r\n                Timer.get({id: id}, function (ds) {\r\n                    $scope.timer = ds;\r\n                    $scope.timer.name = $scope.timer.name + '_copy';\r\n                    delete   $scope.timer.id;\r\n                });\r\n                $edit_table.slideDown();\r\n                $search_table.slideUp();\r\n                upload_table.slideUp();\r\n\r\n                break;\r\n            default:\r\n                $edit_table.slideUp();\r\n                $search_table.slideUp();\r\n                upload_table.slideUp();\r\n                break;\r\n        }\r\n\r\n    };\r\n\r\n\r\n    //删除按钮\r\n    $scope.delete = function (id) {\r\n        $scope.deleteId = id;\r\n        $confirmModal.modal('show');\r\n    };\r\n\r\n    //删除确定\r\n    $scope.confirm_yes = function () {\r\n        Timer.delete({id: $scope.deleteId}, function (rt) {\r\n            $scope.message = rt;\r\n            $scope.reload();\r\n        });\r\n        $confirmModal.modal('hide');\r\n    };\r\n\r\n\r\n    $confirmModal.find('.op_yes').off().click(function () {\r\n        $scope.confirm_yes();\r\n    });\r\n\r\n\r\n    //暂停按钮\r\n    const $pauseConfirmModal = $('#pauseConfirmModal');\r\n\r\n    //暂停按钮\r\n    $scope.pause = function (id) {\r\n        $scope.pauseId = id;\r\n        $pauseConfirmModal.modal('show');\r\n    };\r\n    //暂停确定\r\n    $scope.pauseConfirm_yes = function () {\r\n        Timer.delete({id: $scope.deleteId}, function (rt) {\r\n            $scope.message = rt;\r\n            $scope.reload();\r\n        });\r\n        $pauseConfirmModal.modal('hide');\r\n    };\r\n    //暂停确定\r\n    $pauseConfirmModal.find('.op_yes').off().click(function () {\r\n        $scope.pauseConfirm_yes();\r\n    });\r\n\r\n    //\r\n    $scope.reload = function () {\r\n        $scope.list = Timer.get($scope.page);\r\n    };\r\n\r\n    //文件下载\r\n    $scope.downloadFile = function (itemId) {\r\n\r\n//        console.log(sqlItemId);\r\n\r\n        Timer.download({ id: itemId }, function (response) {\r\n            let fileName = '定时器下载';\r\n            fileName = decodeURI(fileName);\r\n            let url = URL.createObjectURL(new Blob([response.timer]));\r\n            let a = document.createElement('a');\r\n            document.body.appendChild(a); //此处增加了将创建的添加到body当中\r\n            a.href = url;\r\n            a.download = fileName + '-' + itemId + '.json';\r\n            a.target = '_blank';\r\n            a.click();\r\n            a.remove(); //将a标签移除\r\n        }, function (response) {\r\n//            console.log(response);\r\n        });\r\n    }//\r\n});\r\n"]}