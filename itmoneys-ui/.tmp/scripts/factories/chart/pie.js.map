{"version":3,"sources":["factories/chart/pie.js"],"names":["app","factory","pieCharts","key","val","width","height","num","colors","margin","top","right","bottom","left","title","legend","draw","element","data","d3","select","remove","append","attr","parentId","$","trim","p_title","text","style","substring","indexOf","color","scaleOrdinal","range","desc","descs","selectAll","enter","d","i","canvasWidth","canvasHeight","radius","Math","min","arc","outerRadius","innerRadius","pie","sort","value","svg","forEach","total","sum","g","on","html","format","event","pageX","offset","pageY","centroid","per"],"mappings":"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","file":"pie.js","sourcesContent":["'use strict';\r\n\r\napp.factory('PieCharts', function () {\r\n    return function () {\r\n        let pieCharts = {\r\n            key: 'key',\r\n            val: 'count',\r\n            width: 400,\r\n            height: 280,\r\n            num: 0,//标识为第几个chart\r\n            colors: ['#92A2A8'],\r\n            margin: {top: 5, right: 5, bottom: 5, left: 5},\r\n            title: '',\r\n            legend: '',\r\n            draw: function (element, data) {\r\n\r\n                let key = this.key;\r\n                let val = this.val;\r\n                let width = this.width;\r\n                let height = this.height;\r\n                let num = this.num;\r\n                let colors = this.colors;\r\n                let margin = this.margin;\r\n                let legend = this.legend;\r\n\r\n                d3.select('#pie_' + num).remove();\r\n                d3.select(element).append('div').attr('id', 'pie_' + num).attr('class', 'hs_pie');\r\n                let parentId = '#pie_' + num;\r\n\r\n                /**判断是否显示标题**/\r\n                if (this.title != null && $.trim(this.title) != '') {\r\n                    let p_title = d3.select(parentId).append('div').attr('class', 'hs_charts_title').text(this.title);\r\n                    height = height - p_title.style('height').substring(0, p_title.style('height').indexOf('px')) - 5;\r\n                }\r\n\r\n                let color = d3.scaleOrdinal().range(colors);\r\n\r\n                /**如果显示图例**/\r\n                if (legend != null && legend != '' && legend != 'none') {\r\n                    let desc = d3.select(parentId).append('div')\r\n                        .attr('class', 'panel_pie_desc')\r\n                        .attr('id', 'pie_desc_' + num);\r\n\r\n                    let descs = d3.select('#pie_desc_' + num).append('div:ul').attr('class', 'panel_pie_desc_' + num + ' hs_charts_desc_ul');\r\n                    descs.selectAll('ul.panel_pie_desc_' + num).data(data).enter().append('ul.panel_pie_desc_' + num + ':li')\r\n                        .attr('class', 'icon-circle hs_left hs_charts_desc_ul_li')\r\n                        .style('color', function (d, i) {\r\n                            return color(i);\r\n                        })\r\n                        .text(function (d, i) {\r\n                            return d[key] + ' (' + d[val] + ') ';\r\n                        });\r\n\r\n                    height = height - descs.style('height').substring(0, descs.style('height').indexOf('px')) - 5;\r\n                }\r\n                if (legend == 'below')\r\n                    desc.remove();\r\n\r\n                /**计算宽度**/\r\n                let canvasWidth = width - margin.left - margin.right;\r\n                let canvasHeight = height - margin.top - margin.bottom;\r\n                /**计算pie半径**/\r\n                let radius = Math.min(canvasWidth, canvasHeight) / 2;\r\n\r\n                let arc = d3.arc()\r\n                    .outerRadius(radius - 10)\r\n                    .innerRadius(0);\r\n\r\n                let pie = d3.pie()\r\n                    .sort(null)\r\n                    .value(function (d) {\r\n                        return d[val];\r\n                    });\r\n\r\n                let svg = d3.select(parentId).append('svg')\r\n                    .attr('width', canvasWidth)\r\n                    .attr('height', canvasHeight)\r\n                    .append('g')\r\n                    .attr('transform', 'translate(' + canvasWidth / 2 + ',' + canvasHeight / 2 + ')');\r\n\r\n                data.forEach(function (d) {\r\n                    d[val] = +d[val];\r\n                });\r\n\r\n                let total = d3.sum(data, function (d) {\r\n                    return d[val];\r\n                });\r\n\r\n                let g = svg.selectAll('.arc')\r\n                    .data(pie(data))\r\n                    .enter().append('g')\r\n                    .attr('class', 'arc');\r\n\r\n                g.append('path')\r\n                    .attr('d', arc)\r\n                    .attr('class', 'field_charts_point_' + num + ' hs_pie_alt')\r\n                    .style('fill', function (d, i) {\r\n                        return color(i);\r\n                    })\r\n                    .style('stroke', '#FFFFFF')\r\n                    .on('mouseover', function (d, i) {\r\n                        d3.select('#pie_popup_' + num)\r\n                            .html(function () {\r\n                                return d.data[key] + '<br/>' + d3.format('d')(d.data[val] / total * 100, 1) + '%';\r\n                            })\r\n                            .style('left', (d3.event.pageX - $('#pie_' + num).offset().left) + 'px')\r\n                            .style('top', (d3.event.pageY - $('#pie_' + num).offset().top - $('#pie_' + num).height() - margin.top - margin.bottom) + 'px')\r\n                            .attr('class', 'hs_pie_popup')\r\n                        ;\r\n                    })\r\n                    .on('mousemove', function (d, i) {\r\n                        d3.select('#pie_popup_' + num)\r\n                            .html(function () {\r\n                                return d.data[key] + '<br/>' + d3.format('d')(d.data[val] / total * 100, 1) + '%';\r\n                            })\r\n                            .style('left', (d3.event.pageX - $('#pie_' + num).offset().left) + 'px')\r\n                            .style('top', (d3.event.pageY - $('#pie_' + num).offset().top - $('#pie_' + num).height() - margin.top - margin.bottom) + 'px')\r\n                            .attr('class', 'hs_pie_popup')\r\n                        ;\r\n                    })\r\n                    .on('mouseout', function (d, i) {\r\n                        d3.select('#pie_popup_' + num)\r\n                            .on('mouseover', function (d, i) {\r\n                                $(this).attr('class', 'hs_pie_popup')\r\n                            })\r\n                            .on('mouseout', function (d, i) {\r\n                                $(this).attr('class', 'hs_hide')\r\n                            })\r\n                            .attr('class', 'hs_hide')\r\n                        ;\r\n                    })\r\n                ;\r\n\r\n                g.append('text')\r\n                    .attr('transform', function (d) {\r\n                        return 'translate(' + arc.centroid(d) + ')';\r\n                    })\r\n                    .attr('dy', '.35em')\r\n                    .style('text-anchor', 'middle')\r\n                    .text(function (d) {\r\n                        let per = d.data[val] / total * 100;\r\n                        if (per >= 5) {\r\n                            return d3.format('d')(per, 1) + '%';\r\n                        }\r\n                    });\r\n\r\n                $(function () {\r\n//\t\t\t\t\t\t$('.field_charts_point_'+num).tooltipster({\r\n//\t\t\t\t\t\t\ttheme: 'tooltipster-shadow',\r\n//\t\t\t\t\t\t\tcontentAsHTML: true,\r\n//\t\t\t\t\t\t\tinteractive: true,\r\n//\t\t\t\t\t\t\tposition:'right',\r\n//\t\t\t\t\t\t\tfunctionReady:function(){\r\n//\t\t\t\t\t\t\t\t$(this).mousemove(function(e){\r\n//\t\t\t\t\t\t\t\t\tlet offset = {'left':e.pageX,'top':e.pageY}\r\n//\t\t\t\t\t\t\t\t\t$('.tooltipster-base').offset(offset);\r\n//\t\t\t\t\t\t\t\t});\r\n//\t\t\t\t\t\t\t\t$(this).mouseover(function(e){\r\n//\t\t\t\t\t\t\t\t\tconsole.log(e.pageX);\r\n//\t\t\t\t\t\t\t\t\tlet offset = {'left':e.pageX,'top':e.pageY}\r\n//\t\t\t\t\t\t\t\t\t$('.tooltipster-base').offset(offset);\r\n//\t\t\t\t\t\t\t\t});\r\n//\t\t\t\t\t\t\t}\r\n//\t\t\t\t\t\t});\r\n                });\r\n\r\n                if (legend == 'below') {\r\n                    let desc = d3.select(parentId).append('div')\r\n                        .attr('class', 'panel_pie_desc')\r\n                        .attr('id', 'pie_desc_' + num);\r\n\r\n                    let descs = d3.select('#pie_desc_' + num).append('div:ul').attr('class', 'panel_pie_desc_' + num + ' hs_charts_desc_ul');\r\n                    descs.selectAll('ul.panel_pie_desc_' + num).data(data).enter().append('ul.panel_pie_desc_' + num + ':li')\r\n                        .attr('class', 'icon-circle hs_left hs_charts_desc_ul_li')\r\n                        .style('color', function (d, i) {\r\n                            return color(i);\r\n                        })\r\n                        .text(function (d, i) {\r\n                            return d[key] + ' (' + d[val] + ') ';\r\n                        });\r\n                }\r\n\r\n                d3.select(parentId).append('div').attr('id', 'pie_popup_' + num).attr('class', 'hs_hide');\r\n            }\r\n        }\r\n        return pieCharts;\r\n    }\r\n});\r\n"]}