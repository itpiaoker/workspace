{"version":3,"sources":["factories/chart/bar.js"],"names":["app","factory","key","val","width","height","num","colors","margin","top","right","bottom","left","showX","showY","title","legend","xRotate","draw","element","data","d3","select","remove","append","attr","parentId","$","trim","p_title","text","style","substring","indexOf","n","len","i","toString","length","xHeight","color","scaleOrdinal","range","desc","descs","selectAll","enter","d","canvasWidth","canvasHeight","svg","x","scaleBand","round","y","scaleLinear","domain","max","bar","bars","xAxis","axis","scale","orient","tickFormat","xg","call","yAxis","ticks"],"mappings":"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","file":"bar.js","sourcesContent":["'use strict';\r\n\r\napp.factory('BarCharts', function () {\r\n    return function () {\r\n        return {\r\n            key: 'key',\r\n            val: 'count',\r\n            width: 400,\r\n            height: 280,\r\n            num: 0,//标识为第几个chart\r\n            colors: ['#92A2A8'],\r\n            margin: {top: 5, right: 5, bottom: 5, left: 5},\r\n            showX: false,\r\n            showY: false,\r\n            title: '',\r\n            legend: '',\r\n            xRotate: null,\r\n            draw: function (element, data) {\r\n\r\n                let key = this.key;\r\n                let val = this.val;\r\n                let width = this.width;\r\n                let height = this.height;\r\n                let num = this.num;\r\n                let colors = this.colors;\r\n                let margin = this.margin;\r\n                let legend = this.legend;\r\n\r\n                d3.select('#bar_' + num).remove();\r\n                d3.select(element).append('div').attr('id', 'bar_' + num).attr('class', 'hs_bar');\r\n                let parentId = '#bar_' + num;\r\n\r\n                /**判断是否显示标题**/\r\n                if (this.title !== null && $.trim(this.title) !== '') {\r\n                    let p_title = d3.select(parentId).append('div').attr('class', 'hs_charts_title').text(this.title);\r\n                    height = height - p_title.style('height').substring(0, p_title.style('height').indexOf('px')) - 5;\r\n                }\r\n\r\n                /**如果显示Y轴，则计算y轴宽度**/\r\n                if (this.showY) {\r\n                    let n = 0;\r\n                    let len = 0;\r\n                    for (let i in data) {\r\n                        len = data[i][val].toString().length;\r\n                        n = n < len ? len : n;\r\n                    }\r\n                    margin.left += n * 8 + 10;\r\n                }\r\n                /**如果显示X轴，则计算x轴高度**/\r\n                let xHeight = 0;\r\n                if (this.showX) {\r\n                    let n = 0;\r\n                    let len = 0;\r\n                    for (let i in data) {\r\n                        len = data[i][key].toString().length;\r\n                        n = n < len ? len : n;\r\n                    }\r\n                    xHeight = n * 6;\r\n                    xHeight = xHeight < 25 ? 25 : xHeight;\r\n                }\r\n\r\n                let color = d3.scaleOrdinal().range(colors);\r\n                /**如果显示图例**/\r\n                if (legend != null && legend != '' && legend != 'none') {\r\n                    let desc = d3.select(parentId).append('div')\r\n                        .attr('class', 'panel_bar_desc')\r\n                        .attr('id', 'bar_desc_' + num);\r\n\r\n                    let descs = d3.select('#bar_desc_' + num).append('div:ul').attr('class', 'panel_bar_desc_' + num + ' hs_charts_desc_ul');\r\n                    descs.selectAll('ul.panel_bar_desc_' + num).data(data).enter().append('ul.panel_bar_desc_' + num + ':li')\r\n                        .attr('class', 'icon-circle hs_left hs_charts_desc_ul_li')\r\n                        .style('color', function (d, i) {\r\n                            return color(i);\r\n                        })\r\n                        .text(function (d, i) {\r\n                            return d[key] + ' (' + d[val] + ') ';\r\n                        });\r\n\r\n                    height = height - descs.style('height').substring(0, descs.style('height').indexOf('px')) - 5;\r\n                }\r\n                if (legend == 'below')\r\n                    desc.remove();\r\n\r\n                /**计算宽度**/\r\n                let canvasWidth = width - margin.left - margin.right;\r\n                let canvasHeight = height - margin.top - margin.bottom;\r\n                /**如果显示X轴，重新计算画布高度**/\r\n                if (this.showX) {\r\n                    canvasHeight -= (xHeight / 2);\r\n                }\r\n\r\n                let svg = d3.select(parentId)\r\n                    .append('svg:svg')\r\n                    .attr('width', '100%')\r\n                    .attr('height', height)\r\n                    .attr('id', 'bar_charts_' + num)\r\n                ;\r\n\r\n                let x = d3.scaleBand().range(data.length).round([0, canvasWidth], .1);\r\n                let y = d3.scaleLinear().domain([0, d3.max(data, function (d) {\r\n                    return d[val];\r\n                })]).range([canvasHeight, 0]);\r\n\r\n                let bar = d3.select('#bar_charts_' + num)\r\n                    .append('svg:g')\r\n                    .attr('class', 'panel_bar_' + num)\r\n                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\r\n\r\n                let bars = bar.selectAll('g.panel_bar_' + num)\r\n                    .data(data)\r\n                    .enter().append('svg:g')\r\n                    .attr('class', 'bar')\r\n                ;\r\n\r\n                /*let paths = bars.append('svg:rect')\r\n                 .attr('fill', function(d, i) { return color(i); })\r\n                 //\t\t\t\t\t\t.attr('fill-opacity', .6)\r\n                 .attr('x', function(d,i) { return x(i) })\r\n                 .attr('y', function(d) { return y(d[val])})\r\n                 .attr('width', function(d) { return x.(d) })\r\n                 .attr('height', function(d) {return canvasHeight-y(d[val]) })\r\n                 .attr('class','bar_charts_point_'+num+' hs_bar_alt')\r\n                 .on('mouseover',function(d,i){\r\n                 d3.select('#bar_popup_'+num)\r\n                 .html(function(){\r\n                 return d[key] + '<br/>' + d[val];\r\n                 })\r\n                 .style('left', (d3.event.pageX-$('#bar_'+num).offset().left) + 'px')\r\n                 .style('top', (d3.event.pageY-$('#bar_'+num).offset().top-$('#bar_'+num).height()-margin.top-margin.bottom) + 'px')\r\n                 .attr('class','hs_bar_popup')\r\n                 ;\r\n                 })\r\n                 .on('mousemove',function(d,i){\r\n                 d3.select('#bar_popup_'+num)\r\n                 .html(function(){\r\n                 return d[key] + '<br/>' + d[val];\r\n                 })\r\n                 .style('left', (d3.event.pageX-$('#bar_'+num).offset().left) + 'px')\r\n                 .style('top', (d3.event.pageY-$('#bar_'+num).offset().top-$('#bar_'+num).height()-margin.top-margin.bottom) + 'px')\r\n                 .attr('class','hs_bar_popup')\r\n                 ;\r\n                 })\r\n                 .on('mouseout',function(d,i){\r\n                 d3.select('#bar_popup_'+num)\r\n                 .on('mouseover',function(d,i){\r\n                 $(this).attr('class','hs_bar_popup')\r\n                 })\r\n                 .on('mouseout',function(d,i){\r\n                 $(this).attr('class','hs_hide')\r\n                 })\r\n                 .attr('class','hs_hide')\r\n                 ;\r\n                 })\r\n                 ;*/\r\n                $(function () {\r\n                });\r\n\r\n\r\n                /**x,y轴**/\r\n                if (this.showX) {\r\n                    let xAxis = d3.svg.axis().scale(x).orient('bottom').tickFormat(function (d) {\r\n                        return data[d][key]\r\n                    });\r\n                    let xg = svg.append('g')\r\n                        .attr('class', 'hs_charts_x_axis')\r\n                        .attr('transform', 'translate(' + margin.left + ',' + (canvasHeight + margin.top) + ')')\r\n                        .call(xAxis)\r\n                    ;\r\n                    if (!!this.xRotate) {\r\n                        xg.selectAll('text')\r\n                            .attr('transform', 'translate(0,' + (xHeight / (90 / this.xRotate) / 2) + '),rotate(-' + this.xRotate + ')')\r\n                        ;\r\n                    }\r\n                }\r\n                if (this.showY) {\r\n                    let yAxis = d3.svg.axis().scale(y).orient('left').ticks(5);\r\n                    svg.append('g')\r\n                        .attr('class', 'hs_charts_y_axis')\r\n                        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')\r\n                        .call(yAxis);\r\n                }\r\n\r\n                if (legend == 'below') {\r\n                    let desc = d3.select(parentId).append('div')\r\n                        .attr('class', 'panel_bar_desc')\r\n                        .attr('id', 'bar_desc_' + num);\r\n\r\n                    let descs = d3.select('#bar_desc_' + num).append('div:ul').attr('class', 'panel_bar_desc_' + num + ' hs_charts_desc_ul');\r\n                    descs.selectAll('ul.panel_bar_desc_' + num).data(data).enter().append('ul.panel_bar_desc_' + num + ':li')\r\n                        .attr('class', 'icon-circle hs_left hs_charts_desc_ul_li')\r\n                        .style('color', function (d, i) {\r\n                            return color(i);\r\n                        })\r\n                        .text(function (d, i) {\r\n                            return d[key] + ' (' + d[val] + ') ';\r\n                        });\r\n                }\r\n\r\n                d3.select(parentId).append('div').attr('id', 'bar_popup_' + num).attr('class', 'hs_hide');\r\n            }\r\n        };\r\n    };\r\n\r\n});\r\n"]}