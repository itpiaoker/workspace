{"version":3,"sources":["factories/chart/spark_line.js"],"names":["app","factory","key","val","width","height","num","colors","margin","top","right","bottom","left","showX","showY","title","legend","xRotate","draw","element","data","color","d3","scale","ordinal","range","domain","keys","filter","parentId","select","remove","append","attr","$","trim","p_title","text","style","substring","indexOf","n","len","i","toString","length","xHeight","desc","descs","selectAll","enter","d","canvasWidth","canvasHeight","x","rangeRoundBands","y","linear","max","svg","cities","map","name","values","temperature","line","interpolate","rangeBand","city","pointer","on","html","event","pageX","offset","pageY","xAxis","axis","orient","tickFormat","ag","call","yAxis","ticks"],"mappings":"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","file":"spark_line.js","sourcesContent":["'use strict';\r\n\r\napp.factory('SparkLineCharts', function () {\r\n    return function () {\r\n        return {\r\n            key: 'key',\r\n            val: 'count',\r\n            width: 400,\r\n            height: 280,\r\n            num: 0,//标识为第几个chart\r\n            colors: ['#92A2A8'],\r\n            margin: {top: 5, right: 5, bottom: 5, left: 5},\r\n            showX: false,\r\n            showY: false,\r\n            title: '',\r\n            legend: '',\r\n            xRotate: null,\r\n            draw: function (element, data) {\r\n                let key = this.key;\r\n                let val = this.val;\r\n                let width = this.width;\r\n                let height = this.height;\r\n                let num = this.num;\r\n                let colors = this.colors;\r\n                let margin = this.margin;\r\n                let legend = this.legend;\r\n\r\n                let color = d3.scale.ordinal().range(colors);\r\n                color.domain(d3.keys(data[0]).filter(function (key) {\r\n                    return key !== 'key';\r\n                }));\r\n\r\n                let parentId = '#sparkline_' + num;\r\n                if (d3.select(parentId)) {\r\n                    d3.select(parentId).remove();\r\n                }\r\n\r\n                d3.select(element).append('div').attr('id', 'sparkline_' + num).attr('class', 'hs_sparklineCharts');\r\n\r\n                /**判断是否显示标题**/\r\n                if (this.title != null && $.trim(this.title) != '') {\r\n                    let p_title = d3.select(parentId).append('div').attr('class', 'hs_charts_title').text(this.title);\r\n                    height = height - p_title.style('height').substring(0, p_title.style('height').indexOf('px')) - 5;\r\n                }\r\n\r\n                /**如果显示Y轴，则计算y轴宽度**/\r\n                if (this.showY) {\r\n                    let n = 0;\r\n                    let len = 0;\r\n                    for (let i in data) {\r\n                        len = data[i][val].toString().length;\r\n                        n = n < len ? len : n;\r\n                    }\r\n                    margin.left += n * 8 + 10;\r\n                }\r\n                /**如果显示X轴，则计算x轴高度**/\r\n                let xHeight = 0;\r\n                if (this.showX) {\r\n                    let n = 0;\r\n                    let len = 0;\r\n                    for (let i in data) {\r\n                        len = data[i][key].toString().length;\r\n                        n = n < len ? len : n;\r\n                    }\r\n                    xHeight = n * 6;\r\n                    xHeight = xHeight < 25 ? 25 : xHeight;\r\n                }\r\n\r\n                /**如果显示图例**/\r\n                if (legend !== null && legend !== '' && legend !== 'none') {\r\n                    let desc = d3.select(parentId).append('div')\r\n                        .attr('class', 'panel_sparkline_desc')\r\n                        .attr('id', 'sparkline_desc_' + num);\r\n\r\n                    let descs = d3.select('#sparkline_desc_' + num).append('div:ul').attr('class', 'panel_sparkline_desc_' + num + ' hs_charts_desc_ul');\r\n                    descs.selectAll('ul.panel_sparkline_desc_' + num).data(data).enter().append('ul.panel_sparkline_desc_' + num + ':li')\r\n                        .attr('class', 'icon-circle hs_left hs_charts_desc_ul_li')\r\n                        .style('color', function (d, i) {\r\n                            return color(i);\r\n                        })\r\n                        .text(function (d, i) {\r\n                            return d[key] + ' (' + d[val] + ') ';\r\n                        });\r\n\r\n                    height = height - descs.style('height').substring(0, descs.style('height').indexOf('px')) - 5;\r\n                }\r\n                if (legend == 'below')\r\n                    desc.remove();\r\n                /**计算宽度**/\r\n                let canvasWidth = width - margin.left - margin.right;\r\n                let canvasHeight = height - margin.top - margin.bottom;\r\n\r\n                /**如果显示X轴，重新计算画布高度**/\r\n                if (this.showX) {\r\n                    canvasHeight -= (xHeight / 2);\r\n                }\r\n                let x = d3.scale.ordinal().domain(d3.range(data.length)).rangeRoundBands([0, canvasWidth]);\r\n                let y = d3.scale.linear().domain([0, d3.max(data, function (d) {\r\n                    return d[val];\r\n                })]).range([canvasHeight, 0]);\r\n\r\n                let svg = d3.select(parentId)\r\n                    .append('svg:svg')\r\n                    .attr('width', '100%')\r\n                    .attr('height', height)\r\n                    .attr('id', 'sparkline_charts_' + num)\r\n                ;\r\n\r\n                let cities = color.domain().map(function (name) {\r\n                    return {\r\n                        name: name,\r\n                        values: data.map(function (d) {\r\n                            return {key: d.key, temperature: +d[name]};\r\n                        })\r\n                    };\r\n                });\r\n\r\n                let line = d3.svg.line()\r\n                    .interpolate('linear')\r\n                    .x(function (d, i) {\r\n                        return x.rangeBand() * (i + 0.5);\r\n                    })\r\n                    .y(function (d) {\r\n                        return y(d.temperature);\r\n                    });\r\n                let city = svg.selectAll('.city')\r\n                    .data(cities)\r\n                    .enter().append('g')\r\n                    .attr('class', 'city');\r\n\r\n                city.append('path')\r\n                    .attr('class', 'line')\r\n                    .attr('d', function (d) {\r\n                        return line(d.values);\r\n                    })\r\n                    .style('stroke', function (d) {\r\n                        return color(d.name);\r\n                    })\r\n                    .style('fill', 'none')\r\n                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');\r\n\r\n//\t\t\t\t\tcity.append('text')\r\n//\t\t\t\t\t  .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })\r\n//\t\t\t\t\t  .attr('transform', function(d,i) { return 'translate(' + (canvasWidth-x.rangeBand()/2+2) + ',' + y(d.value.temperature) + ')'; })\r\n//\t\t\t\t\t  .attr('x', 3)\r\n//\t\t\t\t\t  .attr('dy', '.35em')\r\n//\t\t\t\t\t  .attr('fill',function(d,i){return color(cities[i].name);})\r\n//\t\t\t\t\t  .text(function(d) { return d.name; });\r\n\r\n                for (let i = 0; i < cities.length; i++) {\r\n                    let pointer = svg.selectAll('.point')\r\n                        .data(cities[i].values)\r\n                        .enter().append('svg:circle');\r\n                    pointer.attr('class', 'chart_point')\r\n                        .attr('stroke', color(cities[i].name))\r\n                        .attr('fill', color(cities[i].name))\r\n                        .attr('cx', function (d, i) {\r\n                            return x.rangeBand() * (i + 0.5);\r\n                        })\r\n                        .attr('cy', function (d, i) {\r\n                            return y(d.temperature);\r\n                        })\r\n                        .attr('r', function (d, i) {\r\n                            return 3;\r\n                        })\r\n                        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')\r\n                    ;\r\n                    pointer.on('mouseover', function (d, i) {\r\n                        d3.select('#sparkline_popup_' + num)\r\n                            .html(function () {\r\n                                return d.key + '<br/>' + d.temperature;\r\n                            })\r\n                            .style('left', (d3.event.pageX - $(parentId).offset().left) + 'px')\r\n                            .style('top', (d3.event.pageY - $(parentId).offset().top - $(parentId).height() - margin.top - margin.bottom) + 'px')\r\n                            .attr('class', 'hs_sparkline_popup')\r\n                        ;\r\n                        return d3.select(this).attr('r', 4);\r\n                    }).on('mouseout', function (d, i) {\r\n                        d3.select('#sparkline_popup_' + num)\r\n                            .on('mouseover', function (d, i) {\r\n                                $(this).attr('class', 'hs_sparkline_popup')\r\n                            })\r\n                            .on('mouseout', function (d, i) {\r\n                                $(this).attr('class', 'hs_hide')\r\n                            })\r\n                            .attr('class', 'hs_hide')\r\n                        ;\r\n                        return d3.select(this).attr('r', 3);\r\n                    });\r\n                }\r\n\r\n                /**x,y轴**/\r\n                if (this.showX) {\r\n                    let xAxis = d3.svg.axis()\r\n                        .scale(x)\r\n                        .orient('bottom')\r\n                        .tickFormat(function (d) {\r\n                            return data[d].key\r\n                        })\r\n                    ;\r\n                    let ag = svg.append('g')\r\n                        .attr('class', 'hs_charts_x_axis')\r\n                        .attr('transform', 'translate(' + margin.left + ',' + (canvasHeight + margin.top) + ')')\r\n                        .call(xAxis);\r\n                    if (!!this.xRotate) {\r\n                        ag.selectAll('text')\r\n                            .attr('transform', 'translate(0,' + (xHeight / (90 / this.xRotate) / 2) + '),rotate(-' + this.xRotate + ')')\r\n                        ;\r\n                    }\r\n                }\r\n                if (this.showY) {\r\n\r\n                    let yAxis = d3.svg.axis()\r\n                        .scale(y)\r\n                        .orient('left')\r\n                        .ticks(5);\r\n\r\n                    svg.append('g')\r\n                        .attr('class', 'hs_charts_y_axis')\r\n                        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')\r\n                        .call(yAxis)\r\n                        .append('text')\r\n                        .attr('transform', 'rotate(-90)')\r\n                        .attr('y', 6)\r\n                        .attr('dy', '.71em')\r\n                        .style('text-anchor', 'end')\r\n//\t\t\t\t\t\t  .text('url数量')\r\n                    ;\r\n                }\r\n\r\n                if (legend === 'below') {\r\n                    let desc = d3.select(parentId).append('div')\r\n                        .attr('class', 'panel_sparkline_desc')\r\n                        .attr('id', 'sparkline_desc_' + num);\r\n\r\n                    let descs = d3.select('#sparkline_desc_' + num).append('div:ul').attr('class', 'panel_sparkline_desc_' + num + ' hs_charts_desc_ul');\r\n                    descs.selectAll('ul.panel_sparkline_desc_' + num).data(data).enter().append('ul.panel_sparkline_desc_' + num + ':li')\r\n                        .attr('class', 'icon-circle hs_left hs_charts_desc_ul_li')\r\n                        .style('color', function (d, i) {\r\n                            return color(i);\r\n                        })\r\n                        .text(function (d, i) {\r\n                            return d[key] + ' (' + d[val] + ') ';\r\n                        });\r\n                }\r\n\r\n                d3.select(parentId).append('div').attr('id', 'sparkline_popup_' + num).attr('class', 'hs_hide');\r\n            }\r\n        };\r\n    }\r\n});\r\n"]}